---
title: "Create Factors"
author: "Sam Thorold"
output:
  html_document:
    keep_md: true
    df_print: paged
    code_folding: show
    toc: true
    toc_float: true
    number_sections: true
---

```{r setup}
knitr::opts_chunk$set(echo = TRUE, fig.height=4)
```

# Definitions and Links

- **[Variables](http://mba.tuck.dartmouth.edu/pages/faculty/ken.french/Data_Library/variable_definitions.html)**
- **[Factors](http://mba.tuck.dartmouth.edu/pages/faculty/ken.french/Data_Library/f-f_5_factors_2x3.html)**


- [Size breakpoints](http://mba.tuck.dartmouth.edu/pages/faculty/ken.french/Data_Library/det_me_breakpoints.html)
- [Size returns](http://mba.tuck.dartmouth.edu/pages/faculty/ken.french/Data_Library/det_port_form_sz.html)


- [Book-to-Market breakpoints](http://mba.tuck.dartmouth.edu/pages/faculty/ken.french/Data_Library/det_beme_breakpoints.html)
- [Book-to-Market returns](http://mba.tuck.dartmouth.edu/pages/faculty/ken.french/Data_Library/det_form_btm.html)


- [Operating Profit breakpoints](http://mba.tuck.dartmouth.edu/pages/faculty/ken.french/Data_Library/det_op_breakpoints.html)
- [Operating Profit returns](http://mba.tuck.dartmouth.edu/pages/faculty/ken.french/Data_Library/det_port_form_op.html)


- [Investment breakpoints](http://mba.tuck.dartmouth.edu/pages/faculty/ken.french/Data_Library/det_inv_breakpoints.html)
- [Investment returns](http://mba.tuck.dartmouth.edu/pages/faculty/ken.french/Data_Library/det_port_form_inv.html)


- [Momentum breakpoints](http://mba.tuck.dartmouth.edu/pages/faculty/ken.french/Data_Library/det_2-12_breakpoints.html)
- [Momentum returns](http://mba.tuck.dartmouth.edu/pages/faculty/ken.french/Data_Library/det_10_port_form_pr_12_2.html)

```{r libraries, message=FALSE, warning=FALSE}
library(data.table)
library(dplyr)
library(dtplyr)
library(ggplot2)
library(knitr)
library(rlang)
```

# Functions

```{r define.stats.helpers}
se = function(x) sd(x, na.rm=TRUE)/sqrt(length(x))

t.stat = function(x) t.test(x)$statistic

sr = function(x) mean(x, na.rm=TRUE) / sd(x, na.rm=TRUE)

stat.summary = function(df){
    return(
        rbind(sapply(df, mean), sapply(df, se), sapply(df, t.stat), sapply(df, sr))
    )
}
```

```{r define.combine.sources}
combine.sources = function(crsp, comp){

    comp = comp %>% select(
        PERMNO, Period, BE, D1.BE, OP, OP.2, OP.OK, CP, GP, Acc, INV, INV.ppe
    )
    df = left_join(crsp, comp, by=c("PERMNO", "Period"))

    df$BM = df$BE/df$M              # Annual, Lagged
    df$bm = log(df$BM)              # Log Annual, Lagged
    df$BMC = df$BE/df$Size          # Annual, Current
    df$BMM = df$BE/df$L1.ME         # Monthly, Current
    
    df$BM[is.infinite(df$BM)] = NA
    df$bm[is.infinite(df$bm)] = NA
    df$BMC[is.infinite(df$BMC)] = NA
    df$BMM[is.infinite(df$BMM)] = NA

    return(df %>% filter(Date>as.Date("1962-06-30")))
}
```

```{r define.assign.bkts}
assign.bkts = function(df, var, quantiles){

    bkt.col = paste0(var, ".B")

    df[,bkt.col] = NA

    brk.cols = paste0("D", quantiles*100)

    for (i in 0:(length(quantiles) - 1)){
        if (i==0){
            ix = df[,var]<=df[,brk.cols[1]]
        } else {
            ix = (df[,var]>df[,brk.cols[i]]) & (df[,var]<=df[,brk.cols[i+1]])
        }

        df[,bkt.col][ix] = i+1
    }

    # for now, breakpoints are always deciles
    # regradless of the quantiles used to assigned buckets
    df[, paste0("D", 1:10*10)] = NULL

    return(df)
}
```

```{r define.ri.adj}
ri.adj.Size = function(df){

    df$adj.L1.ri = 1 + df$L1.ri
    df$adj.L1.ri[df$Month==7] = 1

    df = df %>% group_by(PERMNO, Period) %>% mutate(
        adj.Size=Size*cumprod(adj.L1.ri)
    ) %>% as.data.frame

    return(df)
}
```

# CRSP

```{r read.crsp}
# fread much faster than read.csv
# colClasses='character' prevents scary message about losing data due to
# changing column types part way through reading the data
crsp = fread(
    "C:/Data/CRSP/CRSP_196001_201612_d.csv", colClasses='character', showProgress=FALSE
)
```

```{r munge.crsp, warning=FALSE}
crsp = crsp %>% filter(SHRCD %in% c(10, 11)) %>% filter(EXCHCD %in% c(1, 2, 3))

crsp$SHRCD = NULL  # sharecode no longer needed

setnames(crsp,
         c("EXCHCD", "SICCD", "DLRET", "RET", "PRC", "SHROUT", "vwretd"),
         c("Exchange", "Industry", "dl.ri", "ri", "price", "shares", "rmkt"))

crsp$PERMNO = factor(crsp$PERMNO)
crsp$Date = as.Date(crsp$date, "%Y%m%d")
crsp$Year = as.numeric(format(crsp$Date, "%Y"))
crsp$Month = as.numeric(format(crsp$Date, "%m"))
crsp$Exchange = factor(crsp$Exchange,
                       levels=c("1","2","3"),
                       labels=c("NYSE", "AMEX", "NASDAQ"))
crsp$Industry = factor(crsp$Industry)
crsp$dl.ri = as.numeric(crsp$dl.ri)
crsp$price = as.numeric(crsp$price)
crsp$ri = as.numeric(crsp$ri)
crsp$shares = as.numeric(crsp$shares) / 1000
crsp$rmkt = as.numeric(crsp$rmkt)

summary(crsp %>% select(Date, ri, price, shares))
```

```{r dl.ret}
no.return = is.na(crsp$ri) & is.na(crsp$dl.ri)
crsp$ri[is.na(crsp$ri)] = 0
crsp$dl.ri[is.na(crsp$dl.ri)] = 0
crsp$ri = (1 + crsp$ri) * (1 + crsp$dl.ri) - 1
crsp$ri[no.return] = NA
```

There should be no duplicate $PERMNO$-$date$ pairs
(`r format(sum(duplicated(crsp[,c("PERMNO", "date")])), big.mark=" ")` found).
CRSP data has `r format(nrow(crsp), big.mark=" ")` rows and
`r format(ncol(crsp), big.mark=" ")` columns.

```{r crsp.duplicates}
# duplicated will omit return FALSE for the first instance of a duplicated row
# calling from the top and the bottom ensure all instances are caught
pairs.ix = duplicated(crsp[, c("PERMNO", "date")]) |
           duplicated(crsp[, c("PERMNO", "date")], fromLast=TRUE)
if (sum(pairs.ix)>0){
    kable(head(crsp[pairs.ix], n=10), digits=2, caption="Duplicates")
    crsp = crsp %>% filter(!duplicated(crsp[,c("PERMNO", "date")]))
}
```

## Market Equity, $ME$

```{r me}
crsp$ME = abs(crsp$price) * crsp$shares
summary(crsp$ME)
```

## Holding Period

Most portfolios will be reformed at the end of every June and held for 12 months.

```{r period}
crsp$Period = crsp$Year
crsp$Period[crsp$Month<7] = crsp$Period[crsp$Month<7] - 1
```

## Lagged Market Equity

For portfolios reformed monthly we need the lagged market equity.

```{r l1.me}
crsp = crsp %>% group_by(PERMNO) %>%
    mutate(L1.ME=lag(ME)) %>% as.data.frame
```

## June and December Market Equity, $Size$ and $M$

We need the market equity in June for the $Size$ variable in July
and the market equity in December for the $BM$ variable.

```{r jun.me}
ME = crsp %>% filter(Month==6) %>% select(PERMNO, Period, ME)
ME$Period = ME$Period + 1
ME$Size = ME$ME
ME$ME = NULL
summary(ME)
```

```{r}
missing = ME %>% group_by(Period) %>% summarise(Missing=sum(is.na(Size)))
missing.pct = ME %>% group_by(Period) %>% summarise(Missing=sum(is.na(Size))/n())
ggplot(missing, aes(x=Period, y=Missing)) + geom_line()
ggplot(missing.pct, aes(x=Period, y=Missing)) + geom_line()
```

```{r}
dim(crsp)
```

```{r}
crsp = left_join(crsp, ME, by=c("PERMNO", "Period"))
```

```{r dec.me}
ME = crsp %>% filter(Month==12) %>% select(PERMNO, Period, ME)
ME$Period = ME$Period + 1
ME$M = ME$ME
ME$ME = NULL
summary(ME)
```

```{r}
missing = ME %>% group_by(Period) %>% summarise(Missing=sum(is.na(M)))
missing.pct = ME %>% group_by(Period) %>% summarise(Missing=sum(is.na(M))/n())
ggplot(missing, aes(x=Period, y=Missing)) + geom_line()
ggplot(missing.pct, aes(x=Period, y=Missing)) + geom_line()
```

```{r}
crsp = left_join(crsp, ME, by=c("PERMNO", "Period"))
```

```{r}
dim(crsp)
```

## Prior Returns, $Prior$

```{r prior}
crsp$old.ri = crsp$ri
crsp$ri[is.null(crsp$ri)] = -.9999
crsp = crsp %>% group_by(PERMNO) %>%
    mutate(Prior.sum=
        lag(ri, 2) + lag(ri, 3) + lag(ri, 4) + lag(ri, 5) + lag(ri, 6) +
        lag(ri, 7) + lag(ri, 8) + lag(ri, 9) + lag(ri, 10) + lag(ri, 11) +
        lag(ri, 12),
        Prior.cum=log(
        (1+lag(ri, 2))*(1+lag(ri, 3))*(1+lag(ri, 4))*(1+lag(ri, 5))*(1+lag(ri, 6))*
        (1+lag(ri, 7))*(1+lag(ri, 8))*(1+lag(ri, 9))*(1+lag(ri, 10))*(1+lag(ri, 11))*
        (1+lag(ri, 12))),
        L13.price=lag(price, 13),
        L1.ri=lag(ri),
        L1.ME=lag(ME)
    ) %>% as.data.frame
crsp$ri = crsp$old.ri
crsp$old.ri = NULL

crsp$Prior = crsp$Prior.sum

summary(crsp %>% select(L1.ri, L13.price, Prior.sum, Prior.cum))
```

## Adjusted Size

We hold portfolios for 12 months but the return each month will alter weights.
We only need to do this once because we hold all annual portfolios for the same
period.
Monthly portfolios do not require a size adjustment.

```{r}
crsp = ri.adj.Size(crsp)
```

# COMPUSTAT

```{r read.compustat}
# Don't need to use colClasses here
comp = fread("C:/Data/CRSP/20171123_COMP_196001_201612.csv", showProgress=FALSE)
```

```{r}
comp$GVKEY = NULL

setnames(comp, c("LPERMNO"), c("PERMNO"))

comp$PERMNO = factor(comp$PERMNO)
comp$Date = as.Date(as.character(comp$datadate), "%Y%m%d")
```

## Short Years

There should be no duplicate $PERMNO$-$fyear$ pairs
(`r format(sum(duplicated(comp[,c("PERMNO", "fyear")])), big.mark=" ")` found).
CRSP data has `r format(nrow(comp), big.mark=" ")` rows and
`r format(ncol(comp), big.mark=" ")` columns.

```{r comp.duplicates}
# duplicated will omit return FALSE for the first instance of a duplicated row
# calling from the top and the bottom ensure all instances are caught
pairs.ix = duplicated(comp[, c("PERMNO", "fyear")]) |
           duplicated(comp[, c("PERMNO", "fyear")], fromLast=TRUE)
comp[pairs.ix] %>% arrange(PERMNO, fyear, fyr)
comp = comp %>% filter(!duplicated(comp[,c("PERMNO", "fyear")]))
```

## Holding Period

```{r}
comp$Period = comp$fyear + 1
```

## Book Equity, $BE$

```{r}
comp$ps = comp$pstkrv                                   # Redemption
comp$ps[is.na(comp$ps)] = comp$pstkl[is.na(comp$ps)]    # Liquidation
comp$ps[is.na(comp$ps)] = comp$pstk[is.na(comp$ps)]     # Book
comp$ps[is.na(comp$ps)] = 0

comp$txditc[is.na(comp$txditc)] = 0

# Asness and Frazzini use only seq

comp$BE = comp$seq + comp$txditc - comp$ps

comp$upstk[is.na(comp$upstk)] = 0

# Common Equity PLUS Par Value of Preferred Stock?
comp$BE[is.na(comp$BE)] = comp$ceq[is.na(comp$BE)] + comp$upstk[is.na(comp$BE)]

comp$BE[is.na(comp$BE)] = comp$at[is.na(comp$BE)] - comp$lt[is.na(comp$BE)]

comp = comp %>% group_by(PERMNO) %>% mutate(D1.BE=BE-lag(BE)) %>% as.data.frame

summary(comp[,c("BE", "D1.BE")])
```

## Operating Profit, $OP$

Compustat has $REVT$ and $SALE$ values.
```{r}
summary(comp %>% select(revt, sale))
```

Whichever one we use the expenses check is the same.

```{r}
expenses.OK = !is.na(comp$cogs) | !is.na(!comp$xsga) | !is.na(comp$xint)
comp$cogs[is.na(comp$cogs)] = 0
comp$xsga[is.na(comp$xsga)] = 0
comp$xint[is.na(comp$xint)] = 0

comp$op.revt.OK = !is.na(comp$revt) & expenses.OK
comp$op.sale.OK = !is.na(comp$sale) & expenses.OK

comp$OP.revt.OK = (comp$BE > 0) & comp$op.revt.OK
comp$OP.sale.OK = (comp$BE > 0) & comp$op.sale.OK

comp$OP.revt.OK[is.na(comp$OP.revt.OK)] = FALSE
comp$OP.sale.OK[is.na(comp$OP.sale.OK)] = FALSE

comp$OP.revt = (comp$revt - comp$cogs - comp$xsga - comp$xint)/comp$BE
comp$OP.sale = (comp$sale - comp$cogs - comp$xsga - comp$xint)/comp$BE

summary(comp %>% select(OP.revt, OP.sale))
summary(comp$OP.revt[comp$OP.revt.OK])
summary(comp$OP.sale[comp$OP.sale.OK])

comp %>% select(revt, OP.revt, sale, OP.sale) %>% filter(revt!=sale) %>% head %>% round(3)
```

They seem to be the same.

```{r}
comp$op.OK = comp$op.revt.OK
comp$OP.OK = comp$OP.revt.OK
comp$OP = comp$OP.revt
```

### RnD

```{r}
summary(comp$xrd)
comp$xrd[is.na(comp$xrd)] = 0
comp$OP.2 = (comp$revt - comp$cogs - comp$xsga - comp$xint + comp$xrd)/comp$BE
summary(comp %>% filter(OP.OK) %>% select(OP, OP.2))
```

## Gross Profit, $GP$

```{r}
comp$GP = comp$gp / comp$at
summary(comp$GP)
ix = is.na(comp$GP)
comp$GP[ix] = (comp$revt[ix] - comp$cogs[ix]) / comp$at[ix]
comp$GP[is.infinite(comp$GP)] = NA
summary(comp$GP)
```

## Cash Profit, $CP$

```{r}
summary(comp %>% select(rect, xpp, ap, invt, drc, xacc))
apply(
    comp %>% select(rect, xpp, ap, invt, drc, xacc),
    2,
    function(x) sum(is.na(x)/length(x)*100)
) %>% round(2)
```

Let's assume for now that firms don't need all of these values.
We'll set everything that is missing, except $revt$ and $ap$, to 0.
This essentially requires firms to have both Receivables and Payables to consider their accruals.

```{r}
comp$xpp[is.na(comp$xpp)] = 0
comp$invt[is.na(comp$invt)] = 0
comp$drc[is.na(comp$drc)] = 0
comp$xacc[is.na(comp$xacc)] = 0
```

```{r}
comp = comp %>% group_by(PERMNO) %>% mutate(
    D1.rect=rect-lag(rect), D1.xpp=xpp-lag(xpp),
    D1.ap=ap-lag(ap), D1.invt=invt-lag(invt),
    D1.drc=drc-lag(drc), D1.xacc=xacc-lag(xacc)
) %>% as.data.frame
```

```{r}
summary(comp %>% select(D1.rect, D1.xpp, D1.ap, D1.invt, D1.drc, D1.xacc))
apply(
    comp %>% select(D1.rect, D1.xpp, D1.ap, D1.invt, D1.drc, D1.xacc),
    2,
    function(x) sum(is.na(x)/length(x)*100)
) %>% round(2)
```

```{r}
comp = comp %>% mutate(OP.AccFama=D1.rect+D1.xpp-D1.ap-D1.invt-D1.drc-D1.xacc)
comp = comp %>% mutate(OP.Acc=-D1.rect-D1.invt-D1.xpp+D1.drc+D1.ap+D1.xacc)
summary(comp %>% select(OP.AccFama, OP.Acc))
```

Now for years with missing accruals we don't want this to alter the non-missing operating profits we have.

```{r}
comp$OP.Acc[is.na(comp$OP.Acc)] = 0
summary(comp$OP.Acc)
```

```{r}
comp$CP = (comp$revt-comp$cogs-comp$xsga-comp$xint+comp$xrd+comp$OP.Acc)/comp$BE
summary(comp %>% filter(OP.OK) %>% select(OP, OP.2, GP, CP))
```

## Accruals, $Ac$

```{r}
summary(comp %>% select(act, ch, lct, dlc))
```

We will require that firms have both current assets and liabilities.

```{r}
comp$ch[is.na(comp$ch)] = 0
comp$dlc[is.na(comp$dlc)] = 0

comp$WC = comp$act - comp$ch - comp$lct + comp$dlc
comp = comp %>% group_by(PERMNO) %>% mutate(D1.WC=WC-lag(WC)) %>% as.data.frame

comp$Acc = comp$D1.WC / comp$BE

comp$Acc[is.infinite(comp$Acc)] = 0

summary(comp$Acc[comp$BE>0])
```

## Investment, $INV$

```{r}
comp = comp %>% group_by(PERMNO) %>% mutate(INV=(at-lag(at))/lag(at)) %>%
    as.data.frame
comp$INV[(comp$INV==Inf) | (comp$INV==-Inf)] = NA
summary(comp$INV)
```

Makes more sense to define investment as the change in PPE plus depreciation.

```{r}
comp = comp %>% group_by(PERMNO) %>%
    mutate(INV.ppe=(ppent-lag(ppent)+dp)/lag(ppent)) %>%
    as.data.frame
comp$INV.ppe[(comp$INV.ppe==Inf) | (comp$INV.ppe==-Inf)] = NA
summary(comp$INV.ppe)
```

## Missing Values

```{r comp.missing.val}
missing = comp %>% filter(Date>as.Date("1963-06-30")) %>%
    group_by(Period) %>% summarise(
        BE=sum(is.na(BE)),
        OP=sum(!op.OK),
        GP=sum(is.na(GP)),
        OP_BE=sum(!OP.OK),
        INV=sum(is.na(INV))
) %>% melt(id="Period") %>% filter(!is.na(Period))

ggplot(missing, aes(x=Period, color=variable)) + geom_line(aes(y=value))
```

```{r comp.missing.pct}
missing = comp %>% filter(Date>as.Date("1963-06-30")) %>%
    group_by(Period) %>% summarise(
        BE=sum(is.na(BE))/n(),
        OP=sum(!op.OK)/n(),
        GP=sum(is.na(GP))/n(),
        OP_BE=sum(!OP.OK)/n(),
        INV=sum(is.na(INV))/n()
) %>% melt(id="Period") %>% filter(!is.na(Period))

ggplot(missing, aes(x=Period, color=variable)) + geom_line(aes(y=value))
```

# Univariate Sorts

## $Size$

* Annual rebalance

```{r, warning=FALSE}
df = combine.sources(crsp, comp)
```

### $ME$ Decile Breakpoints

```{r me.deciles}
quantiles = 1:10/10

nyse = df %>% filter(Exchange=="NYSE", !is.na(ME)) %>% select(Date, PERMNO, ME)

breakpoints = nyse %>% arrange(Date, ME) %>% group_by(Date) %>% summarize(
    D10=ME[.1*n()], D20=ME[.2*n()],
    D30=ME[.3*n()], D40=ME[.4*n()],
    D50=ME[.5*n()], D60=ME[.6*n()],
    D70=ME[.7*n()], D80=ME[.8*n()],
    D90=ME[.9*n()], D100=ME[n()]) %>% as.data.frame
write.csv(breakpoints, "C:/Data/Thesis/ME_Decile_Breakpoints.csv")
```

### $Size$ Deciles

```{r size.deciles}
quantiles = 1:10/10

nyse = df %>% filter(
    Exchange=="NYSE", Month==7, !is.na(Size)
    ) %>% select(Period, PERMNO, Size)

breakpoints = nyse %>% arrange(Period, Size) %>% group_by(Period) %>% summarize(
    D10=Size[.1*n()], D20=Size[.2*n()],
    D30=Size[.3*n()], D40=Size[.4*n()],
    D50=Size[.5*n()], D60=Size[.6*n()],
    D70=Size[.7*n()], D80=Size[.8*n()],
    D90=Size[.9*n()], D100=Size[n()]) %>% as.data.frame

breakpoints$Period = breakpoints$Period + 1

breakpoints[, c("PERMNO", "Size")] = NULL

df = left_join(df, breakpoints, by=c("Period"))
```

```{r}
df = assign.bkts(df, "Size", quantiles)
```

```{r}
df %>% group_by(Size.B, Date) %>% summarize(N=n()) %>% group_by(Size.B) %>%
    summarise(avg.N=mean(N))
```

$Size$ adjusted for last month's return

```{r}
# df = ri.adj.Size(df)

df = df %>% group_by(Size.B, Date) %>% mutate(
    adj.bkt.Size=sum(adj.Size, na.rm=TRUE)
) %>% as.data.frame
df$wt.ri = df$ri * df$adj.Size / df$adj.bkt.Size
```

### Returns

```{r}
decile.returns = df %>%
    dcast(Date ~ Size.B, fun.aggregate=sum, value.var="wt.ri", na.rm=TRUE)
write.csv(decile.returns, "C:/Data/Thesis/Size_Decile_Returns.csv")
round(colMeans(decile.returns %>% select(-Date)) * 100, 2)
```

![French Website $Size$ Decile Returns](C:/Data/FrenchDartmouth/10_ME.JPG)

## $BM$ (Annual, Lagged)

* Annual rebalance

```{r, warning=FALSE}
df = combine.sources(crsp, comp)
df = df %>% filter(!is.na(BM), !is.na(Size), BE>0)
```

### $BM$ Decile Breakpoints

```{r bm.deciles}
quantiles = 1:10/10

nyse = df %>% filter(Exchange=="NYSE", Month==7) %>% select(Period, PERMNO, BM)

breakpoints = nyse %>% arrange(Period, BM) %>% group_by(Period) %>% summarize(
    D10=BM[.1*n()], D20=BM[.2*n()],
    D30=BM[.3*n()], D40=BM[.4*n()],
    D50=BM[.5*n()], D60=BM[.6*n()],
    D70=BM[.7*n()], D80=BM[.8*n()],
    D90=BM[.9*n()], D100=BM[n()]) %>% as.data.frame
write.csv(breakpoints, "C:/Data/Thesis/BM_Decile_Breakpoints.csv")

breakpoints$Period = breakpoints$Period + 1

breakpoints[, c("PERMNO", "BM")] = NULL

df = left_join(df, breakpoints, by=c("Period"))

df = assign.bkts(df, "BM", quantiles)
```

```{r}
df %>% group_by(BM.B, Date) %>% summarize(N=n()) %>% group_by(BM.B) %>%
    summarise(avg.N=mean(N))
```

```{r}
# df = ri.adj.Size(df)

df = df %>% group_by(BM.B, Date) %>% mutate(
    adj.bkt.Size=sum(adj.Size, na.rm=TRUE)
) %>% as.data.frame
df$wt.ri = df$ri * df$adj.Size / df$adj.bkt.Size
```

### Returns

```{r}
decile.returns = df %>%
    dcast(Date ~ BM.B, fun.aggregate=sum, value.var="wt.ri", na.rm=TRUE)
write.csv(decile.returns, "C:/Data/Thesis/BM_Decile_Returns.csv")
round(colMeans(decile.returns %>% select(-Date)) * 100, 2)
```

![French Website $BM$ Decile Returns](C:/Data/FrenchDartmouth/10_BM.JPG)

### $ME$

```{r}
df %>% group_by(BM.B, Date) %>% summarise(avg.ME=mean(ME, na.rm=TRUE)) %>%
    group_by(BM.B) %>% summarise(avg.ME=mean(avg.ME)) %>% round(2)
```

### $Size$

```{r}
df %>% group_by(BM.B, Date) %>% summarise(avg.Size=mean(Size, na.rm=TRUE)) %>%
    group_by(BM.B) %>% summarise(avg.Size=mean(avg.Size)) %>% round(2)
```

### $Prior$

```{r}
df %>% group_by(BM.B, Date) %>% summarise(avg.Prior=mean(Prior, na.rm=TRUE)) %>%
    group_by(BM.B) %>% summarise(avg.Prior=mean(avg.Prior)) %>% round(2)
```

## Forecasting $BE$

We want to distinguish between changes in price and changes in expected $BE$.

Exhibit 4 from Asness and Frazzini (2013).

$$BM_t = \beta_0 + \beta_1\cdot BM_{t-1} + \beta_2\cdot BM_{t-1}^{Current ME}$$

```{r, warning=FALSE}
df = combine.sources(crsp, comp)
df = df %>% filter(!is.na(BM), Month==7)
```

```{r}
df = df %>% group_by(PERMNO) %>% mutate(
    L1.BM=lag(BM),
    L1.BMC=lag(BMC),
    L1.BMC_L1.BM=L1.BMC-L1.BM) %>% as.data.frame
```

```{r}
summary(df %>% select(PERMNO, L1.BM, L1.BMC, L1.BMC_L1.BM))
```

```{r}
formula.str = "BM ~ L1.BM + L1.BMC_L1.BM"
results = c()
for (period in 1964:2016){
    dt = df %>% filter(Period==period)
    results = rbind(results, lm(formula(formula.str), data=dt)$coefficients)
}

results = as.data.frame(results)
results$diff = results$L1.BM - results$L1.BMC_L1.BM

rbind(sapply(results, mean), sapply(results, se), sapply(results, t.stat))

```


## $\Delta log(Book Price/Share)$

Exhibit 5 from Asness and Frazzini (2013).

We want to forecast unobserved changes in book value per share.
Regress changes in book value per share on the lagged prior returns.
Prior returns are already lagged but the change in book value per share uses a
lag. Also see Sloan et al. (2017).

```{r, warning=FALSE}
df = combine.sources(crsp, comp)

df$bp = log(df$BE / df$shares)

df = df %>% filter(!is.na(bp), !is.infinite(bp), Month==7) %>% group_by(PERMNO) %>%
    mutate(D1.bp=bp-lag(bp), L1.Prior=lag(Prior.cum)) %>% as.data.frame
```

```{r}
summary(df %>% select(PERMNO, Period, D1.bp, L1.Prior))
```

```{r}
df %>% group_by(Period) %>% summarise(N=n())
```

```{r}
formula.str = "D1.bp ~ L1.Prior"

results = c()
for (period in 1964:2016){
    dt = df %>% filter(Period==period)
    results = rbind(results, lm(formula(formula.str), data=dt)$coefficients)
}

results = as.data.frame(results)

rbind(sapply(results, mean), sapply(results, se), sapply(results, t.stat))
```

## $BM_C$ (Annual, Current)

* Annual rebalance

```{r, warning=FALSE}
df = combine.sources(crsp, comp)
df = df %>% filter(!is.na(BMC), !is.na(Size), BE>0)
```

### $BM$ Decile Breakpoints

```{r bmc.deciles}
quantiles = 1:10/10

nyse = df %>% filter(Exchange=="NYSE", Month==7) %>% select(Period, PERMNO, BMC)

breakpoints = nyse %>% arrange(Period, BMC) %>% group_by(Period) %>% summarize(
    D10=BMC[.1*n()], D20=BMC[.2*n()],
    D30=BMC[.3*n()], D40=BMC[.4*n()],
    D50=BMC[.5*n()], D60=BMC[.6*n()],
    D70=BMC[.7*n()], D80=BMC[.8*n()],
    D90=BMC[.9*n()], D100=BMC[n()]) %>% as.data.frame
write.csv(breakpoints, "C:/Data/Thesis/BMC_Decile_Breakpoints.csv")

breakpoints$Period = breakpoints$Period + 1

breakpoints[, c("PERMNO", "BMC")] = NULL

df = left_join(df, breakpoints, by=c("Period"))

df = assign.bkts(df, "BMC", quantiles)
```

```{r}
df %>% group_by(BMC.B, Date) %>% summarize(N=n()) %>% group_by(BMC.B) %>%
    summarise(avg.N=mean(N))
```

```{r}
# df = ri.adj.Size(df)

df = df %>% group_by(BMC.B, Date) %>% mutate(
    adj.bkt.Size=sum(adj.Size, na.rm=TRUE)
) %>% as.data.frame
df$wt.ri = df$ri * df$adj.Size / df$adj.bkt.Size
```

### Returns

```{r}
decile.returns = df %>%
    dcast(Date ~ BMC.B, fun.aggregate=sum, value.var="wt.ri", na.rm=TRUE)
write.csv(decile.returns, "C:/Data/Thesis/BMC_Decile_Returns.csv")
round(colMeans(decile.returns %>% select(-Date)) * 100, 2)
```

### $ME$

```{r}
df %>% group_by(BMC.B, Date) %>% summarise(avg.ME=mean(ME, na.rm=TRUE)) %>%
    group_by(BMC.B) %>% summarise(avg.ME=mean(avg.ME)) %>% round(2)
```

### $Size$

```{r}
df %>% group_by(BMC.B, Date) %>% summarise(avg.Size=mean(Size, na.rm=TRUE)) %>%
    group_by(BMC.B) %>% summarise(avg.Size=mean(avg.Size)) %>% round(2)
```

### $Prior$

```{r}
df %>% group_by(BMC.B, Date) %>% summarise(avg.Prior=mean(Prior, na.rm=TRUE)) %>%
    group_by(BMC.B) %>% summarise(avg.Prior=mean(avg.Prior)) %>% round(2)
```

## $BM_M$ (Monthly, Current)

* Monthly rebalance

```{r, warning=FALSE}
df = combine.sources(crsp, comp)
df = df %>% filter(!is.na(BMM), !is.na(L1.ME), BE>0)
```

### $BMM$ Decile Breakpoints

```{r bmm.deciles}
quantiles = 1:10/10

nyse = df %>% filter(Exchange=="NYSE") %>% select(Date, PERMNO, BMM)

breakpoints = nyse %>% arrange(Date, BMM) %>% group_by(Date) %>% summarize(
    D10=BMM[.1*n()], D20=BMM[.2*n()],
    D30=BMM[.3*n()], D40=BMM[.4*n()],
    D50=BMM[.5*n()], D60=BMM[.6*n()],
    D70=BMM[.7*n()], D80=BMM[.8*n()],
    D90=BMM[.9*n()], D100=BMM[n()]) %>% as.data.frame
write.csv(breakpoints, "C:/Data/Thesis/BMM_Decile_Breakpoints.csv")

# breakpoints$Period = breakpoints$Period + 1

breakpoints[, c("PERMNO", "BMM")] = NULL

df = left_join(df, breakpoints, by=c("Date"))

df = assign.bkts(df, "BMM", quantiles)
```

```{r}
df %>% group_by(BMM.B, Date) %>% summarize(N=n()) %>% group_by(BMM.B) %>%
    summarise(avg.N=mean(N))
```

```{r}
# df = ri.adj.Size(df)

df = df %>% group_by(BMM.B, Date) %>% mutate(
    bkt.L1.ME=sum(L1.ME, na.rm=TRUE)
) %>% as.data.frame
df$wt.ri = df$ri * df$L1.ME / df$bkt.L1.ME
```

### Returns

```{r}
decile.returns = df %>%
    dcast(Date ~ BMM.B, fun.aggregate=sum, value.var="wt.ri", na.rm=TRUE)
write.csv(decile.returns, "C:/Data/Thesis/BMM_Decile_Returns.csv")
round(colMeans(decile.returns %>% select(-Date)) * 100, 2)
```

### $ME$

```{r}
df %>% group_by(BMM.B, Date) %>% summarise(avg.ME=mean(ME, na.rm=TRUE)) %>%
    group_by(BMM.B) %>% summarise(avg.ME=mean(avg.ME)) %>% round(2)
```

### $Size$

```{r}
df %>% group_by(BMM.B, Date) %>% summarise(avg.Size=mean(Size, na.rm=TRUE)) %>%
    group_by(BMM.B) %>% summarise(avg.Size=mean(avg.Size)) %>% round(2)
```

### $Prior$

```{r}
df %>% group_by(BMM.B, Date) %>% summarise(avg.Prior=mean(Prior, na.rm=TRUE)) %>%
    group_by(BMM.B) %>% summarise(avg.Prior=mean(avg.Prior)) %>% round(2)
```

## $OP$

* Annual rebalance

```{r, warning=FALSE}
df = combine.sources(crsp, comp)
df = df %>% filter(OP.OK, !is.na(Size))
```

### $OP$ Decile Breakpoints

```{r op.deciles}
quantiles = 1:10/10

nyse = df %>% filter(Exchange=="NYSE", Month==7) %>% select(Period, PERMNO, OP)

breakpoints = nyse %>% arrange(Period, OP) %>% group_by(Period) %>% summarize(
    D10=OP[.1*n()], D20=OP[.2*n()],
    D30=OP[.3*n()], D40=OP[.4*n()],
    D50=OP[.5*n()], D60=OP[.6*n()],
    D70=OP[.7*n()], D80=OP[.8*n()],
    D90=OP[.9*n()], D100=OP[n()]) %>% as.data.frame
write.csv(breakpoints, "C:/Data/Thesis/OP_Decile_Breakpoints.csv")

breakpoints$Period = breakpoints$Period + 1

breakpoints[, c("PERMNO", "OP")] = NULL

df = left_join(df, breakpoints, by=c("Period"))
```

```{r}
df = assign.bkts(df, "OP", quantiles)
```

```{r}
df %>% group_by(OP.B, Date) %>% summarize(N=n()) %>% group_by(OP.B) %>%
    summarise(avg.N=mean(N))
```

```{r}
# df = ri.adj.Size(df)

df = df %>% group_by(OP.B, Date) %>% mutate(
    adj.bkt.Size=sum(adj.Size, na.rm=TRUE)
) %>% as.data.frame
df$wt.ri = df$ri * df$adj.Size / df$adj.bkt.Size
```

### Returns

```{r}
decile.returns = df %>%
    dcast(Date ~ OP.B, fun.aggregate=sum, value.var="wt.ri", na.rm=TRUE)
write.csv(decile.returns, "C:/Data/Thesis/OP_Decile_Returns.csv")
round(colMeans(decile.returns %>% select(-Date)) * 100, 2)
```

![French Website $OP$ Decile Returns](C:/Data/FrenchDartmouth/10_OP.JPG)

### $BM$

```{r}
df %>% group_by(OP.B, Date) %>% summarise(avg.BM=mean(BM, na.rm=TRUE)) %>%
    group_by(OP.B) %>% summarise(avg.BM=mean(avg.BM)) %>% round(2)
```

### Monthly $BM$

```{r}
df %>% group_by(OP.B, Date) %>% summarise(avg.BMM=mean(BMM, na.rm=TRUE)) %>%
    group_by(OP.B) %>% summarise(avg.BMM=mean(avg.BMM)) %>% round(2)
```

### $Prior$

```{r}
df %>% group_by(OP.B, Date) %>% summarise(avg.Prior=mean(Prior, na.rm=TRUE)) %>%
    group_by(OP.B) %>% summarise(avg.Prior=mean(avg.Prior)) %>% round(2)
```

### $INV$

```{r}
df %>% group_by(OP.B, Date) %>% summarise(avg.INV=mean(INV, na.rm=TRUE)) %>%
    group_by(OP.B) %>% summarise(avg.INV=mean(avg.INV)) %>% round(2)
```

## $OP.2$

* Annual rebalance

```{r, warning=FALSE}
df = combine.sources(crsp, comp)
df = df %>% filter(OP.OK, !is.na(Size))
```

### $OP.2$ Decile Breakpoints

```{r OP.2.deciles}
quantiles = 1:10/10

nyse = df %>% filter(Exchange=="NYSE", Month==7) %>% select(Period, PERMNO, OP.2)

breakpoints = nyse %>% arrange(Period, OP.2) %>% group_by(Period) %>% summarize(
    D10=OP.2[.1*n()], D20=OP.2[.2*n()],
    D30=OP.2[.3*n()], D40=OP.2[.4*n()],
    D50=OP.2[.5*n()], D60=OP.2[.6*n()],
    D70=OP.2[.7*n()], D80=OP.2[.8*n()],
    D90=OP.2[.9*n()], D100=OP.2[n()]) %>% as.data.frame
write.csv(breakpoints, "C:/Data/Thesis/OP_RnD_Decile_Breakpoints.csv")

breakpoints$Period = breakpoints$Period + 1

breakpoints[, c("PERMNO", "OP.2")] = NULL

df = left_join(df, breakpoints, by=c("Period"))
```

```{r}
df = assign.bkts(df, "OP.2", quantiles)
```

```{r}
df %>% group_by(OP.2.B, Date) %>% summarize(N=n()) %>% group_by(OP.2.B) %>%
    summarise(avg.N=mean(N))
```

```{r}
# df = ri.adj.Size(df)

df = df %>% group_by(OP.2.B, Date) %>% mutate(
    adj.bkt.Size=sum(adj.Size, na.rm=TRUE)
) %>% as.data.frame
df$wt.ri = df$ri * df$adj.Size / df$adj.bkt.Size
```

### Returns

```{r}
decile.returns = df %>%
    dcast(Date ~ OP.2.B, fun.aggregate=sum, value.var="wt.ri", na.rm=TRUE)
write.csv(decile.returns, "C:/Data/Thesis/OP_RnD_Decile_Returns.csv")
round(colMeans(decile.returns %>% select(-Date)) * 100, 2)
```

## $GP$

* Annual rebalance

```{r, warning=FALSE}
df = combine.sources(crsp, comp)
df = df %>% filter(!is.na(GP), !is.na(Size))
```

### $GP$ Decile Breakpoints

```{r gp.deciles}
quantiles = 1:10/10

nyse = df %>% filter(Exchange=="NYSE", Month==7) %>% select(Period, PERMNO, GP)

breakpoints = nyse %>% arrange(Period, GP) %>% group_by(Period) %>% summarize(
    D10=GP[.1*n()], D20=GP[.2*n()],
    D30=GP[.3*n()], D40=GP[.4*n()],
    D50=GP[.5*n()], D60=GP[.6*n()],
    D70=GP[.7*n()], D80=GP[.8*n()],
    D90=GP[.9*n()], D100=GP[n()]) %>% as.data.frame
write.csv(breakpoints, "C:/Data/Thesis/GP_Decile_Breakpoints.csv")

breakpoints$Period = breakpoints$Period + 1

breakpoints[, c("PERMNO", "GP")] = NULL

df = left_join(df, breakpoints, by=c("Period"))
```

```{r}
df = assign.bkts(df, "GP", quantiles)
```

```{r}
df %>% group_by(GP.B, Date) %>% summarize(N=n()) %>% group_by(GP.B) %>%
    summarise(avg.N=mean(N))
```

```{r}
# df = ri.adj.Size(df)

df = df %>% group_by(GP.B, Date) %>% mutate(
    adj.bkt.Size=sum(adj.Size, na.rm=TRUE)
) %>% as.data.frame
df$wt.ri = df$ri * df$adj.Size / df$adj.bkt.Size
```

### Returns

```{r}
decile.returns = df %>%
    dcast(Date ~ GP.B, fun.aggregate=sum, value.var="wt.ri", na.rm=TRUE)
write.csv(decile.returns, "C:/Data/Thesis/GP_Decile_Returns.csv")
round(colMeans(decile.returns %>% select(-Date)) * 100, 2)
```

### $BM$

```{r}
df %>% group_by(GP.B, Date) %>% summarise(avg.BM=mean(BM, na.rm=TRUE)) %>%
    group_by(GP.B) %>% summarise(avg.BM=mean(avg.BM)) %>% round(2)
```

```{r}
x= df %>% filter(Month==7) %>%
    dcast(Date ~ GP.B, fun.aggregate=mean, value.var="BM", na.rm=TRUE)
x$diff = x$`1` - x$`10`
mean(x$diff, na.rm=TRUE)
se(x$diff)
```

### Monthly $BM$

```{r}
df %>% group_by(GP.B, Date) %>% summarise(avg.BMM=mean(BMM, na.rm=TRUE)) %>%
    group_by(GP.B) %>% summarise(avg.BMM=mean(avg.BMM)) %>% round(2)
```

## $CP$

* Annual rebalance

```{r, warning=FALSE}
df = combine.sources(crsp, comp)
df = df %>% filter(OP.OK, !is.na(Size))
```

### $CP$ Decile Breakpoints

```{r CP.deciles}
quantiles = 1:10/10

nyse = df %>% filter(Exchange=="NYSE", Month==7) %>% select(Period, PERMNO, CP)

breakpoints = nyse %>% arrange(Period, CP) %>% group_by(Period) %>% summarize(
    D10=CP[.1*n()], D20=CP[.2*n()],
    D30=CP[.3*n()], D40=CP[.4*n()],
    D50=CP[.5*n()], D60=CP[.6*n()],
    D70=CP[.7*n()], D80=CP[.8*n()],
    D90=CP[.9*n()], D100=CP[n()]) %>% as.data.frame
write.csv(breakpoints, "C:/Data/Thesis/CP_Decile_Breakpoints.csv")

breakpoints$Period = breakpoints$Period + 1

breakpoints[, c("PERMNO", "CP")] = NULL

df = left_join(df, breakpoints, by=c("Period"))
```

```{r}
df = assign.bkts(df, "CP", quantiles)
```

```{r}
df %>% group_by(CP.B, Date) %>% summarize(N=n()) %>% group_by(CP.B) %>%
    summarise(avg.N=mean(N))
```

```{r}
# df = ri.adj.Size(df)

df = df %>% group_by(CP.B, Date) %>% mutate(
    adj.bkt.Size=sum(adj.Size, na.rm=TRUE)
) %>% as.data.frame
df$wt.ri = df$ri * df$adj.Size / df$adj.bkt.Size
```

### Returns

```{r}
decile.returns = df %>%
    dcast(Date ~ CP.B, fun.aggregate=sum, value.var="wt.ri", na.rm=TRUE)
write.csv(decile.returns, "C:/Data/Thesis/CP_Decile_Returns.csv")
round(colMeans(decile.returns %>% select(-Date)) * 100, 2)
```

## $INV$

* Annual rebalance

### Assets

```{r, warning=FALSE}
df = combine.sources(crsp, comp)
df = df %>% filter(!is.na(INV), !is.na(Size))
```

### INV Decile Breakpoints

```{r INV.deciles}
quantiles = 1:10/10

nyse = df %>% filter(Exchange=="NYSE", Month==7) %>% select(Period, PERMNO, INV)

breakpoints = nyse %>% arrange(Period, INV) %>% group_by(Period) %>% summarize(
    D10=INV[.1*n()], D20=INV[.2*n()],
    D30=INV[.3*n()], D40=INV[.4*n()],
    D50=INV[.5*n()], D60=INV[.6*n()],
    D70=INV[.7*n()], D80=INV[.8*n()],
    D90=INV[.9*n()], D100=INV[n()]) %>% as.data.frame
write.csv(breakpoints, "C:/Data/Thesis/INV_Assets_Decile_Breakpoints.csv")

breakpoints$Period = breakpoints$Period + 1

breakpoints[, c("PERMNO", "INV")] = NULL

df = left_join(df, breakpoints, by=c("Period"))
```

```{r}
df = assign.bkts(df, "INV", quantiles)
```

```{r}
df %>% group_by(INV.B, Date) %>% summarize(N=n()) %>% group_by(INV.B) %>%
    summarise(avg.N=mean(N))
```

```{r}
# df = ri.adj.Size(df)

df = df %>% group_by(INV.B, Date) %>% mutate(
    adj.bkt.Size=sum(adj.Size, na.rm=TRUE)
) %>% as.data.frame
df$wt.ri = df$ri * df$adj.Size / df$adj.bkt.Size
```

### Returns

```{r}
decile.returns = df %>%
    dcast(Date ~ INV.B, fun.aggregate=sum, value.var="wt.ri", na.rm=TRUE)
write.csv(decile.returns, "C:/Data/Thesis/INV_Assets_Decile_Returns.csv")
round(colMeans(decile.returns %>% select(-Date)) * 100, 2)
```

### PPE

```{r, warning=FALSE}
df = combine.sources(crsp, comp)
df = df %>% filter(!is.na(INV.ppe), !is.na(Size))
```

### INV Decile Breakpoints

```{r inv.ppe.deciles}
quantiles = 1:10/10

nyse = df %>% filter(Exchange=="NYSE", Month==7) %>% select(Period, PERMNO, INV.ppe)

breakpoints = nyse %>% arrange(Period, INV.ppe) %>% group_by(Period) %>% summarize(
    D10=INV.ppe[.1*n()], D20=INV.ppe[.2*n()],
    D30=INV.ppe[.3*n()], D40=INV.ppe[.4*n()],
    D50=INV.ppe[.5*n()], D60=INV.ppe[.6*n()],
    D70=INV.ppe[.7*n()], D80=INV.ppe[.8*n()],
    D90=INV.ppe[.9*n()], D100=INV.ppe[n()]) %>% as.data.frame
write.csv(breakpoints, "C:/Data/Thesis/INV_PPE_Decile_Breakpoints.csv")

breakpoints$Period = breakpoints$Period + 1

breakpoints[, c("PERMNO", "INV.ppe")] = NULL

df = left_join(df, breakpoints, by=c("Period"))
```

```{r}
df = assign.bkts(df, "INV.ppe", quantiles)
```

```{r}
df %>% group_by(INV.ppe.B, Date) %>% summarize(N=n()) %>% group_by(INV.ppe.B) %>%
    summarise(avg.N=mean(N))
```

```{r}
# df = ri.adj.Size(df)

df = df %>% group_by(INV.ppe.B, Date) %>% mutate(
    adj.bkt.Size=sum(adj.Size, na.rm=TRUE)
) %>% as.data.frame
df$wt.ri = df$ri * df$adj.Size / df$adj.bkt.Size
```

### Returns

```{r}
decile.returns = df %>%
    dcast(Date ~ INV.ppe.B, fun.aggregate=sum, value.var="wt.ri", na.rm=TRUE)
write.csv(decile.returns, "C:/Data/Thesis/INV_PPE_Decile_Returns.csv")
round(colMeans(decile.returns %>% select(-Date)) * 100, 2)
```

### Assets

```{r, warning=FALSE}
df = combine.sources(crsp, comp)
#df$INV = df$INV
df = df %>% filter(!is.na(INV), !is.na(Size))
```

### INV Decile Breakpoints

```{r inv.deciles}
quantiles = 1:10/10

nyse = df %>% filter(Exchange=="NYSE", Month==7) %>% select(Period, PERMNO, INV)

breakpoints = nyse %>% arrange(Period, INV) %>% group_by(Period) %>% summarize(
    D10=INV[.1*n()], D20=INV[.2*n()],
    D30=INV[.3*n()], D40=INV[.4*n()],
    D50=INV[.5*n()], D60=INV[.6*n()],
    D70=INV[.7*n()], D80=INV[.8*n()],
    D90=INV[.9*n()], D100=INV[n()]) %>% as.data.frame
write.csv(breakpoints, "C:/Data/Thesis/INV_Decile_Breakpoints.csv")

breakpoints$Period = breakpoints$Period + 1

breakpoints[, c("PERMNO", "INV")] = NULL

df = left_join(df, breakpoints, by=c("Period"))
```

```{r}
df = assign.bkts(df, "INV", quantiles)
```

```{r}
df %>% group_by(INV.B, Date) %>% summarize(N=n()) %>% group_by(INV.B) %>%
    summarise(avg.N=mean(N))
```

```{r}
# df = ri.adj.Size(df)

df = df %>% group_by(INV.B, Date) %>% mutate(
    adj.bkt.Size=sum(adj.Size, na.rm=TRUE)
) %>% as.data.frame
df$wt.ri = df$ri * df$adj.Size / df$adj.bkt.Size
```

### Returns

```{r}
decile.returns = df %>%
    dcast(Date ~ INV.B, fun.aggregate=sum, value.var="wt.ri", na.rm=TRUE)
write.csv(decile.returns, "C:/Data/Thesis/INV_Decile_Returns.csv")
round(colMeans(decile.returns %>% select(-Date)) * 100, 2)
```

![French Website $INV$ Decile Returns](C:/Data/FrenchDartmouth/10_INV.JPG)

### $ME$

```{r}
df %>% group_by(INV.B, Date) %>% summarise(avg.ME=mean(ME, na.rm=TRUE)) %>%
    group_by(INV.B) %>% summarise(avg.ME=mean(avg.ME)) %>% round(2)
```

### $Size$

```{r}
df %>% group_by(INV.B, Date) %>% summarise(avg.Size=mean(Size, na.rm=TRUE)) %>%
    group_by(INV.B) %>% summarise(avg.Size=mean(avg.Size)) %>% round(2)
```

### $BM$

```{r}
df %>% group_by(INV.B, Date) %>% summarise(avg.BM=mean(BM, na.rm=TRUE)) %>%
    group_by(INV.B) %>% summarise(avg.BM=mean(avg.BM)) %>% round(2)
```

### Monthly $BM$

```{r}
df %>% group_by(INV.B, Date) %>% summarise(avg.BMM=mean(BMM, na.rm=TRUE)) %>%
    group_by(INV.B) %>% summarise(avg.BMM=mean(avg.BMM)) %>% round(2)
```

### $OP$

```{r}
df[df$OP.OK, ] %>% group_by(INV.B, Date) %>% summarise(avg.OP=mean(OP, na.rm=TRUE)) %>%
    group_by(INV.B) %>% summarise(avg.OP=mean(avg.OP)) %>% round(2)
```

```{r}
df[df$BE>0, ] %>% group_by(INV.B, Date) %>% summarise(avg.OP=mean(OP, na.rm=TRUE)) %>%
    group_by(INV.B) %>% summarise(avg.OP=mean(avg.OP)) %>% round(2)
```

### $GP$

```{r}
df %>% group_by(INV.B, Date) %>% summarise(avg.GP=mean(GP, na.rm=TRUE)) %>%
    group_by(INV.B) %>% summarise(avg.GP=mean(avg.GP)) %>% round(2)
```

### $CP$

```{r}
df[df$OP.OK, ] %>% group_by(INV.B, Date) %>% summarise(avg.CP=mean(CP, na.rm=TRUE)) %>%
    group_by(INV.B) %>% summarise(avg.CP=mean(avg.CP)) %>% round(2)
```

```{r}
df[df$BE>0, ] %>% group_by(INV.B, Date) %>% summarise(avg.CP=mean(CP, na.rm=TRUE)) %>%
    group_by(INV.B) %>% summarise(avg.CP=mean(avg.CP)) %>% round(2)
```

### $Acc$

```{r}
df %>% group_by(INV.B, Date) %>% summarise(avg.Acc=mean(Acc, na.rm=TRUE)) %>%
    group_by(INV.B) %>% summarise(avg.Acc=mean(avg.Acc)) %>% round(2)
```

### $Prior$

```{r}
df %>% group_by(INV.B, Date) %>% summarise(avg.Prior=mean(Prior, na.rm=TRUE)) %>%
    group_by(INV.B) %>% summarise(avg.Prior=mean(avg.Prior)) %>% round(2)
```

## $Prior$

* Monthly rebalance

```{r, warning=FALSE}
df = combine.sources(crsp, comp)
df = df %>% filter(!is.na(Prior), !is.na(L13.price), !is.na(L1.ri), !is.na(L1.ME))
```

### $Prior$ Decile Breakpoints

```{r prior.deciles}
quantiles = 1:10/10

nyse = df %>% filter(Exchange=="NYSE") %>% select(Date, PERMNO, Prior)

breakpoints = nyse %>% arrange(Date, Prior) %>% group_by(Date) %>% summarize(
    D10=Prior[.1*n()], D20=Prior[.2*n()],
    D30=Prior[.3*n()], D40=Prior[.4*n()],
    D50=Prior[.5*n()], D60=Prior[.6*n()],
    D70=Prior[.7*n()], D80=Prior[.8*n()],
    D90=Prior[.9*n()], D100=Prior[n()]) %>% as.data.frame
write.csv(breakpoints, "C:/Data/Thesis/Prior_Decile_Breakpoints.csv")

# breakpoints$Period = breakpoints$Period + 1

breakpoints[, c("PERMNO", "Prior")] = NULL

df = left_join(df, breakpoints, by=c("Date"))

df = assign.bkts(df, "Prior", quantiles)
```

```{r}
df %>% group_by(Prior.B, Date) %>% summarize(N=n()) %>% group_by(Prior.B) %>%
    summarise(avg.N=mean(N))
```

```{r}
# df = ri.adj.Size(df)

df = df %>% group_by(Prior.B, Date) %>% mutate(
    bkt.L1.ME=sum(L1.ME, na.rm=TRUE)
) %>% as.data.frame
df$wt.ri = df$ri * df$L1.ME / df$bkt.L1.ME
```

### Returns

```{r}
decile.returns = df %>%
    dcast(Date ~ Prior.B, fun.aggregate=sum, value.var="wt.ri", na.rm=TRUE)
write.csv(decile.returns, "C:/Data/Thesis/Prior_Decile_Returns.csv")
round(colMeans(decile.returns %>% select(-Date)) * 100, 2)
```

### $ME$

```{r}
df %>% group_by(Prior.B, Date) %>% summarise(avg.ME=mean(ME, na.rm=TRUE)) %>%
    group_by(Prior.B) %>% summarise(avg.ME=mean(avg.ME)) %>% round(2)
```

### $Size$

```{r}
df %>% group_by(Prior.B, Date) %>% summarise(avg.Size=mean(Size, na.rm=TRUE)) %>%
    group_by(Prior.B) %>% summarise(avg.Size=mean(avg.Size)) %>% round(2)
```

### $BM$

```{r}
df %>% group_by(Prior.B, Date) %>% summarise(avg.BM=mean(BM, na.rm=TRUE)) %>%
    group_by(Prior.B) %>% summarise(avg.BM=mean(avg.BM)) %>% round(2)
```

### Monthly $BM$

```{r}
df %>% group_by(Prior.B, Date) %>% summarise(avg.BMM=mean(BMM, na.rm=TRUE)) %>%
    group_by(Prior.B) %>% summarise(avg.BMM=mean(avg.BMM)) %>% round(2)
```

## $Acc$

* Annual rebalance

```{r, warning=FALSE}
df = combine.sources(crsp, comp)
df = df %>% filter(!is.na(Acc), !is.na(Size))
```

### $Acc$ Decile Breakpoints

```{r Acc.deciles}
quantiles = 1:10/10

nyse = df %>% filter(Exchange=="NYSE", Month==7) %>% select(Period, PERMNO, Acc)

breakpoints = nyse %>% arrange(Period, Acc) %>% group_by(Period) %>% summarize(
    D10=Acc[.1*n()], D20=Acc[.2*n()],
    D30=Acc[.3*n()], D40=Acc[.4*n()],
    D50=Acc[.5*n()], D60=Acc[.6*n()],
    D70=Acc[.7*n()], D80=Acc[.8*n()],
    D90=Acc[.9*n()], D100=Acc[n()]) %>% as.data.frame
write.csv(breakpoints, "C:/Data/Thesis/Acc_Decile_Breakpoints.csv")

breakpoints$Period = breakpoints$Period + 1

breakpoints[, c("PERMNO", "Acc")] = NULL

df = left_join(df, breakpoints, by=c("Period"))
```

```{r}
df = assign.bkts(df, "Acc", quantiles)
```

```{r}
df %>% group_by(Acc.B, Date) %>% summarize(N=n()) %>% group_by(Acc.B) %>%
    summarise(avg.N=mean(N))
```

```{r}
# df = ri.adj.Size(df)

df = df %>% group_by(Acc.B, Date) %>% mutate(
    adj.bkt.Size=sum(adj.Size, na.rm=TRUE)
) %>% as.data.frame
df$wt.ri = df$ri * df$adj.Size / df$adj.bkt.Size
```

### Returns

```{r}
decile.returns = df %>%
    dcast(Date ~ Acc.B, fun.aggregate=sum, value.var="wt.ri", na.rm=TRUE)
write.csv(decile.returns, "C:/Data/Thesis/Acc_Decile_Returns.csv")
round(colMeans(decile.returns %>% select(-Date)) * 100, 2)
```

### $ME$

```{r}
df %>% group_by(Acc.B, Date) %>% summarise(avg.ME=mean(ME, na.rm=TRUE)) %>%
    group_by(Acc.B) %>% summarise(avg.ME=mean(avg.ME)) %>% round(2)
```

## $Vol$

* Daily data
* Residuals from three factor model

### Returns

# Multivariate Sorts

## $Size$ and $BM$

* Annual rebalance

```{r, warning=FALSE}
df = combine.sources(crsp, comp)
df = df %>% filter(!is.na(BM), !is.na(Size), BE>0)
```

### $Size$ Quintiles

```{r size.bm.quintiles}
quantiles = 1:5/5

nyse = df %>% filter(Exchange=="NYSE", Month==7) %>% select(Period, PERMNO, Size, BM)

breakpoints = nyse %>% arrange(Period, Size) %>% group_by(Period) %>% summarize(
    D10=Size[.1*n()], D20=Size[.2*n()],
    D30=Size[.3*n()], D40=Size[.4*n()],
    D50=Size[.5*n()], D60=Size[.6*n()],
    D70=Size[.7*n()], D80=Size[.8*n()],
    D90=Size[.9*n()], D100=Size[n()]) %>% as.data.frame
breakpoints$Period = breakpoints$Period + 1
breakpoints[, c("PERMNO", "Size")] = NULL
df = left_join(df, breakpoints, by=c("Period"))
df = assign.bkts(df, "Size", quantiles)
```

### $BM$ Quintiles

```{r bm.quintiles}
breakpoints = nyse %>% arrange(Period, BM) %>% group_by(Period) %>% summarize(
    D10=BM[.1*n()], D20=BM[.2*n()],
    D30=BM[.3*n()], D40=BM[.4*n()],
    D50=BM[.5*n()], D60=BM[.6*n()],
    D70=BM[.7*n()], D80=BM[.8*n()],
    D90=BM[.9*n()], D100=BM[n()]) %>% as.data.frame
breakpoints$Period = breakpoints$Period + 1
breakpoints[, c("PERMNO", "BM")] = NULL
df = left_join(df, breakpoints, by=c("Period"))
df = assign.bkts(df, "BM", quantiles)
```

```{r}
df %>% group_by(Size.B, BM.B, Date) %>% summarize(N=n()) %>% group_by(Size.B, BM.B) %>%
    dcast(Size.B ~ BM.B, value.var="N", fun.aggregate=mean, na.rm=TRUE) %>%
    round(0)
```

```{r}
# df = ri.adj.Size(df)

df = df %>% group_by(Size.B, BM.B, Date) %>% mutate(
    adj.bkt.Size=sum(adj.Size, na.rm=TRUE)
) %>% as.data.frame
df$wt.ri = df$ri * df$adj.Size / df$adj.bkt.Size
```

### Returns

```{r}
df$Size.BM.B = interaction(df$Size.B, df$BM.B)
df$wt.ri = df$wt.ri * 100

returns = df %>% dcast(Date ~ Size.BM.B, fun.aggregate=sum, value.var="wt.ri", na.rm=TRUE)
write.csv(returns, "C:/Data/Thesis/25_Size_BM_Returns.csv")

df %>% group_by(Size.B, BM.B, Date) %>% summarise(rp=sum(wt.ri, na.rm=TRUE)) %>%
    dcast(Size.B ~ BM.B, fun.aggregate=mean, value.var="rp", na.rm=TRUE) %>%
    select(-`NA`) %>% filter(!is.na(Size.B)) %>% round(digits=2)
```

![French Website 25 $Size-BM$ Returns](C:/Data/FrenchDartmouth/25_Size_BM.JPG)

## $Size$ and $BM_M$

* Monthly rebalance

```{r, warning=FALSE}
df = combine.sources(crsp, comp)
df = df %>% filter(!is.na(L1.ME), !is.na(BMM), BE>0)
```

### $Size$ Quintiles

```{r size.bmm.quintiles}
quantiles = 1:5/5

nyse = df %>% filter(Exchange=="NYSE") %>% select(Date, PERMNO, L1.ME, BMM)

breakpoints = nyse %>% arrange(Date, L1.ME) %>% group_by(Date) %>% summarize(
    D10=L1.ME[.1*n()], D20=L1.ME[.2*n()],
    D30=L1.ME[.3*n()], D40=L1.ME[.4*n()],
    D50=L1.ME[.5*n()], D60=L1.ME[.6*n()],
    D70=L1.ME[.7*n()], D80=L1.ME[.8*n()],
    D90=L1.ME[.9*n()], D100=L1.ME[n()]) %>% as.data.frame
# breakpoints$Period = breakpoints$Period + 1
breakpoints[, c("PERMNO", "L1.ME")] = NULL
df = left_join(df, breakpoints, by=c("Date"))
df = assign.bkts(df, "L1.ME", quantiles)
```

### $BM_m$ Quintiles

```{r bmm.quintiles}
breakpoints = nyse %>% arrange(Date, BMM) %>% group_by(Date) %>% summarize(
    D10=BMM[.1*n()], D20=BMM[.2*n()],
    D30=BMM[.3*n()], D40=BMM[.4*n()],
    D50=BMM[.5*n()], D60=BMM[.6*n()],
    D70=BMM[.7*n()], D80=BMM[.8*n()],
    D90=BMM[.9*n()], D100=BMM[n()]) %>% as.data.frame
# breakpoints$Period = breakpoints$Period + 1
breakpoints[, c("PERMNO", "BMM")] = NULL
df = left_join(df, breakpoints, by=c("Date"))
df = assign.bkts(df, "BMM", quantiles)
```

```{r}
df$L1.ME.B = factor(df$L1.ME.B, labels=c("ME1", "ME2", "ME3", "ME4", "ME5"))
df$BMM.B = factor(df$BMM.B, labels=c("BMM1", "BMM2", "BMM3", "BMM4", "BMM5"))
```

```{r}
# df = ri.adj.Size(df)

df = df %>% group_by(L1.ME.B, BMM.B, Date) %>% mutate(
    bkt.L1.ME=sum(L1.ME, na.rm=TRUE)
) %>% as.data.frame
df$wt.ri = df$ri * df$L1.ME / df$bkt.L1.ME
```

### Returns

```{r}
df$L1.ME.BMM.B = interaction(df$L1.ME.B, df$BMM.B)
df$wt.ri = df$wt.ri * 100

returns = df %>% dcast(Date ~ L1.ME.BMM.B, fun.aggregate=sum, value.var="wt.ri", na.rm=TRUE)
colnames(returns)
write.csv(returns %>% select(-`NA`), "C:/Data/Thesis/25_L1ME_BMM_Returns.csv")
```

## $Size$ and $OP$

* Annual rebalance

```{r, warning=FALSE}
df = combine.sources(crsp, comp)
df = df %>% filter(!is.na(Size), OP.OK)
```

### $Size$ Quintiles

```{r size.op.quintiles}
quantiles = 1:5/5

nyse = df %>% filter(Exchange=="NYSE", Month==7) %>% select(Period, PERMNO, Size, OP)

breakpoints = nyse %>% arrange(Period, Size) %>% group_by(Period) %>% summarize(
    D10=Size[.1*n()], D20=Size[.2*n()],
    D30=Size[.3*n()], D40=Size[.4*n()],
    D50=Size[.5*n()], D60=Size[.6*n()],
    D70=Size[.7*n()], D80=Size[.8*n()],
    D90=Size[.9*n()], D100=Size[n()]) %>% as.data.frame
breakpoints$Period = breakpoints$Period + 1
breakpoints[, c("PERMNO", "Size")] = NULL
df = left_join(df, breakpoints, by=c("Period"))
df = assign.bkts(df, "Size", quantiles)
```

### $OP$ Quintiles

```{r op.quintiles}
breakpoints = nyse %>% arrange(Period, OP) %>% group_by(Period) %>% summarize(
    D10=OP[.1*n()], D20=OP[.2*n()],
    D30=OP[.3*n()], D40=OP[.4*n()],
    D50=OP[.5*n()], D60=OP[.6*n()],
    D70=OP[.7*n()], D80=OP[.8*n()],
    D90=OP[.9*n()], D100=OP[n()]) %>% as.data.frame
breakpoints$Period = breakpoints$Period + 1
breakpoints[, c("PERMNO", "OP")] = NULL
df = left_join(df, breakpoints, by=c("Period"))
df = assign.bkts(df, "OP", quantiles)
```

```{r}
df %>% group_by(Size.B, OP.B, Date) %>% summarize(N=n()) %>% group_by(Size.B, OP.B) %>%
    dcast(Size.B ~ OP.B, value.var="N", fun.aggregate=mean, na.rm=TRUE) %>%
    round(0)
```

```{r}
# df = ri.adj.Size(df)

df = df %>% group_by(Size.B, OP.B, Date) %>% mutate(
    adj.bkt.Size=sum(adj.Size, na.rm=TRUE)
) %>% as.data.frame
df$wt.ri = df$ri * df$adj.Size / df$adj.bkt.Size
```

### Returns

```{r}
df$Size.OP.B = interaction(df$Size.B, df$OP.B)
df$wt.ri = df$wt.ri * 100

returns = df %>% dcast(Date ~ Size.OP.B, fun.aggregate=sum, value.var="wt.ri", na.rm=TRUE)
write.csv(returns, "C:/Data/Thesis/25_Size_OP_Returns.csv")

df %>% group_by(Size.B, OP.B, Date) %>% summarise(rp=sum(wt.ri, na.rm=TRUE)) %>%
    dcast(Size.B ~ OP.B, fun.aggregate=mean, value.var="rp", na.rm=TRUE) %>%
    select(-`NA`) %>% filter(!is.na(Size.B)) %>% round(digits=2)
```

![French Website 25 $Size-OP$ Returns](C:/Data/FrenchDartmouth/25_Size_OP.JPG)

## $Size$ and $GP$

* Annual rebalance

```{r, warning=FALSE}
df = combine.sources(crsp, comp)
df = df %>% filter(!is.na(Size), !is.na(GP))
```

### $Size$ Quintiles

```{r size.GP.quintiles}
quantiles = 1:5/5

nyse = df %>% filter(Exchange=="NYSE", Month==7) %>% select(Period, PERMNO, Size, GP)

breakpoints = nyse %>% arrange(Period, Size) %>% group_by(Period) %>% summarize(
    D10=Size[.1*n()], D20=Size[.2*n()],
    D30=Size[.3*n()], D40=Size[.4*n()],
    D50=Size[.5*n()], D60=Size[.6*n()],
    D70=Size[.7*n()], D80=Size[.8*n()],
    D90=Size[.9*n()], D100=Size[n()]) %>% as.data.frame
breakpoints$Period = breakpoints$Period + 1
breakpoints[, c("PERMNO", "Size")] = NULL
df = left_join(df, breakpoints, by=c("Period"))
df = assign.bkts(df, "Size", quantiles)
```

### $GP$ Quintiles

```{r GP.quintiles}
breakpoints = nyse %>% arrange(Period, GP) %>% group_by(Period) %>% summarize(
    D10=GP[.1*n()], D20=GP[.2*n()],
    D30=GP[.3*n()], D40=GP[.4*n()],
    D50=GP[.5*n()], D60=GP[.6*n()],
    D70=GP[.7*n()], D80=GP[.8*n()],
    D90=GP[.9*n()], D100=GP[n()]) %>% as.data.frame
breakpoints$Period = breakpoints$Period + 1
breakpoints[, c("PERMNO", "GP")] = NULL
df = left_join(df, breakpoints, by=c("Period"))
df = assign.bkts(df, "GP", quantiles)
```

```{r}
df$Size.B = factor(df$Size.B, labels=c("ME1", "ME2", "ME3", "ME4", "ME5"))
df$GP.B = factor(df$GP.B, labels=c("GP1", "GP2", "GP3", "GP4", "GP5"))
```

```{r}
# df = ri.adj.Size(df)

df = df %>% group_by(Size.B, GP.B, Date) %>% mutate(
    adj.bkt.Size=sum(adj.Size, na.rm=TRUE)
) %>% as.data.frame
df$wt.ri = df$ri * df$adj.Size / df$adj.bkt.Size
```

### Returns

```{r}
df$Size.GP.B = interaction(df$Size.B, df$GP.B)
df$wt.ri = df$wt.ri * 100

returns = df %>% dcast(Date ~ Size.GP.B, fun.aggregate=sum, value.var="wt.ri", na.rm=TRUE)
write.csv(returns %>% select(-`NA`), "C:/Data/Thesis/25_Size_GP_Returns.csv")
```

## $Size$ and $CP$

* Annual rebalance

```{r, warning=FALSE}
df = combine.sources(crsp, comp)
df = df %>% filter(!is.na(Size), OP.OK)
```

### $Size$ Quintiles

```{r size.CP.quintiles}
quantiles = 1:5/5

nyse = df %>% filter(Exchange=="NYSE", Month==7) %>% select(Period, PERMNO, Size, CP)

breakpoints = nyse %>% arrange(Period, Size) %>% group_by(Period) %>% summarize(
    D10=Size[.1*n()], D20=Size[.2*n()],
    D30=Size[.3*n()], D40=Size[.4*n()],
    D50=Size[.5*n()], D60=Size[.6*n()],
    D70=Size[.7*n()], D80=Size[.8*n()],
    D90=Size[.9*n()], D100=Size[n()]) %>% as.data.frame
breakpoints$Period = breakpoints$Period + 1
breakpoints[, c("PERMNO", "Size")] = NULL
df = left_join(df, breakpoints, by=c("Period"))
df = assign.bkts(df, "Size", quantiles)
```

### $CP$ Quintiles

```{r CP.quintiles}
breakpoints = nyse %>% arrange(Period, CP) %>% group_by(Period) %>% summarize(
    D10=CP[.1*n()], D20=CP[.2*n()],
    D30=CP[.3*n()], D40=CP[.4*n()],
    D50=CP[.5*n()], D60=CP[.6*n()],
    D70=CP[.7*n()], D80=CP[.8*n()],
    D90=CP[.9*n()], D100=CP[n()]) %>% as.data.frame
breakpoints$Period = breakpoints$Period + 1
breakpoints[, c("PERMNO", "CP")] = NULL
df = left_join(df, breakpoints, by=c("Period"))
df = assign.bkts(df, "CP", quantiles)
```

```{r}
df$Size.B = factor(df$Size.B, labels=c("ME1", "ME2", "ME3", "ME4", "ME5"))
df$CP.B = factor(df$CP.B, labels=c("CP1", "CP2", "CP3", "CP4", "CP5"))
```

```{r}
# df = ri.adj.Size(df)

df = df %>% group_by(Size.B, CP.B, Date) %>% mutate(
    adj.bkt.Size=sum(adj.Size, na.rm=TRUE)
) %>% as.data.frame
df$wt.ri = df$ri * df$adj.Size / df$adj.bkt.Size
```

### Returns

```{r}
df$Size.CP.B = interaction(df$Size.B, df$CP.B)
df$wt.ri = df$wt.ri * 100

returns = df %>% dcast(Date ~ Size.CP.B, fun.aggregate=sum, value.var="wt.ri", na.rm=TRUE)
write.csv(returns %>% select(-`NA`), "C:/Data/Thesis/25_Size_CP_Returns.csv")
```

## $Size$ and $INV$

* Annual rebalance

```{r, warning=FALSE}
df = combine.sources(crsp, comp)
df = df %>% filter(!is.na(Size), !is.na(INV))
```

### $Size$ Quintiles

```{r size.inv.quintiles}
quantiles = 1:5/5

nyse = df %>% filter(Exchange=="NYSE", Month==7) %>% select(Period, PERMNO, Size, INV)

breakpoints = nyse %>% arrange(Period, Size) %>% group_by(Period) %>% summarize(
    D10=Size[.1*n()], D20=Size[.2*n()],
    D30=Size[.3*n()], D40=Size[.4*n()],
    D50=Size[.5*n()], D60=Size[.6*n()],
    D70=Size[.7*n()], D80=Size[.8*n()],
    D90=Size[.9*n()], D100=Size[n()]) %>% as.data.frame
breakpoints$Period = breakpoints$Period + 1
breakpoints[, c("PERMNO", "Size")] = NULL
df = left_join(df, breakpoints, by=c("Period"))
df = assign.bkts(df, "Size", quantiles)
```

### $INV$ Quintiles

```{r inv.quintiles}
breakpoints = nyse %>% arrange(Period, INV) %>% group_by(Period) %>% summarize(
    D10=INV[.1*n()], D20=INV[.2*n()],
    D30=INV[.3*n()], D40=INV[.4*n()],
    D50=INV[.5*n()], D60=INV[.6*n()],
    D70=INV[.7*n()], D80=INV[.8*n()],
    D90=INV[.9*n()], D100=INV[n()]) %>% as.data.frame
breakpoints$Period = breakpoints$Period + 1
breakpoints[, c("PERMNO", "INV")] = NULL
df = left_join(df, breakpoints, by=c("Period"))
df = assign.bkts(df, "INV", quantiles)
```

```{r}
df %>% group_by(Size.B, INV.B, Date) %>% summarize(N=n()) %>% group_by(Size.B, INV.B) %>%
    dcast(Size.B ~ INV.B, value.var="N", fun.aggregate=mean, na.rm=TRUE) %>%
    round(0)
```

```{r}
# df = ri.adj.Size(df)

df = df %>% group_by(Size.B, INV.B, Date) %>% mutate(
    adj.bkt.Size=sum(adj.Size, na.rm=TRUE)
) %>% as.data.frame
df$wt.ri = df$ri * df$adj.Size / df$adj.bkt.Size
```

### Returns

```{r}
df$Size.INV.B = interaction(df$Size.B, df$INV.B)
df$wt.ri = df$wt.ri * 100

returns = df %>% dcast(Date ~ Size.INV.B, fun.aggregate=sum, value.var="wt.ri", na.rm=TRUE)
write.csv(returns, "C:/Data/Thesis/25_Size_INV_Returns.csv")

df %>% group_by(Size.B, INV.B, Date) %>% summarise(rp=sum(wt.ri, na.rm=TRUE)) %>%
    dcast(Size.B ~ INV.B, fun.aggregate=mean, value.var="rp", na.rm=TRUE) %>%
    select(-`NA`) %>% filter(!is.na(Size.B)) %>% round(digits=2)
```

![French Website 25 $Size-INV$ Returns](C:/Data/FrenchDartmouth/25_Size_INV.JPG)

### $BM$

```{r}
df %>% group_by(Size.B, INV.B, Date) %>% summarise(avg.BM=mean(BM, na.rm=TRUE)) %>%
    dcast(Size.B ~ INV.B, fun.aggregate=mean, value.var="avg.BM", na.rm=TRUE) %>%
    select(-`NA`) %>% filter(!is.na(Size.B)) %>% round(digits=2)
```

### $BM_M$

```{r}
df %>% group_by(Size.B, INV.B, Date) %>% summarise(avg.BMM=mean(BMM, na.rm=TRUE)) %>%
    dcast(Size.B ~ INV.B, fun.aggregate=mean, value.var="avg.BMM", na.rm=TRUE) %>%
    select(-`NA`) %>% filter(!is.na(Size.B)) %>% round(digits=2)
```

### $OP$

```{r}
df[df$OP.OK, ] %>% group_by(Size.B, INV.B, Date) %>% summarise(avg.OP=mean(OP, na.rm=TRUE)) %>%
    dcast(Size.B ~ INV.B, fun.aggregate=mean, value.var="avg.OP", na.rm=TRUE) %>%
    select(-`NA`) %>% filter(!is.na(Size.B)) %>% round(digits=2)
```

### $GP$

```{r}
df %>% group_by(Size.B, INV.B, Date) %>% summarise(avg.GP=mean(GP, na.rm=TRUE)) %>%
    dcast(Size.B ~ INV.B, fun.aggregate=mean, value.var="avg.GP", na.rm=TRUE) %>%
    select(-`NA`) %>% filter(!is.na(Size.B)) %>% round(digits=2)
```

### $CP$

```{r}
df[df$OP.OK, ] %>% group_by(Size.B, INV.B, Date) %>% summarise(avg.CP=mean(CP, na.rm=TRUE)) %>%
    dcast(Size.B ~ INV.B, fun.aggregate=mean, value.var="avg.CP", na.rm=TRUE) %>%
    select(-`NA`) %>% filter(!is.na(Size.B)) %>% round(digits=2)
```

### $Acc$

```{r}
df %>% group_by(Size.B, INV.B, Date) %>% summarise(avg.Acc=mean(Acc, na.rm=TRUE)) %>%
    dcast(Size.B ~ INV.B, fun.aggregate=mean, value.var="avg.Acc", na.rm=TRUE) %>%
    select(-`NA`) %>% filter(!is.na(Size.B)) %>% round(digits=2)
```

## $Size$ and $Prior$

* Monthly rebalance

```{r, warning=FALSE}
df = combine.sources(crsp, comp)
df = df %>% filter(!is.na(L1.ME), !is.na(Prior), !is.na(L13.price), !is.na(L1.ri))
```

### $Size$ Quintiles

```{r size.prior.quintiles}
quantiles = 1:5/5

nyse = df %>% filter(Exchange=="NYSE") %>% select(Date, PERMNO, L1.ME, Prior)

breakpoints = nyse %>% arrange(Date, L1.ME) %>% group_by(Date) %>% summarize(
    D10=L1.ME[.1*n()], D20=L1.ME[.2*n()],
    D30=L1.ME[.3*n()], D40=L1.ME[.4*n()],
    D50=L1.ME[.5*n()], D60=L1.ME[.6*n()],
    D70=L1.ME[.7*n()], D80=L1.ME[.8*n()],
    D90=L1.ME[.9*n()], D100=L1.ME[n()]) %>% as.data.frame
# breakpoints$Period = breakpoints$Period + 1
breakpoints[, c("PERMNO", "L1.ME")] = NULL
df = left_join(df, breakpoints, by=c("Date"))
df = assign.bkts(df, "L1.ME", quantiles)
```

### $Prior$ Quintiles

```{r prior.quintiles}
breakpoints = nyse %>% arrange(Date, Prior) %>% group_by(Date) %>% summarize(
    D10=Prior[.1*n()], D20=Prior[.2*n()],
    D30=Prior[.3*n()], D40=Prior[.4*n()],
    D50=Prior[.5*n()], D60=Prior[.6*n()],
    D70=Prior[.7*n()], D80=Prior[.8*n()],
    D90=Prior[.9*n()], D100=Prior[n()]) %>% as.data.frame
# breakpoints$Period = breakpoints$Period + 1
breakpoints[, c("PERMNO", "Prior")] = NULL
df = left_join(df, breakpoints, by=c("Date"))
df = assign.bkts(df, "Prior", quantiles)
```

```{r}
df %>% group_by(L1.ME.B, Prior.B, Date) %>% summarize(N=n()) %>% group_by(L1.ME.B, Prior.B) %>%
    dcast(L1.ME.B ~ Prior.B, value.var="N", fun.aggregate=mean, na.rm=TRUE) %>%
    round(0)
```

```{r}
# df = ri.adj.Size(df)

df = df %>% group_by(L1.ME.B, Prior.B, Date) %>% mutate(
    bkt.L1.ME=sum(L1.ME, na.rm=TRUE)
) %>% as.data.frame
df$wt.ri = df$ri * df$L1.ME / df$bkt.L1.ME
```

### Returns

```{r}
df$L1.ME.Prior.B = interaction(df$L1.ME.B, df$Prior.B)
df$wt.ri = df$wt.ri * 100

returns = df %>% dcast(Date ~ L1.ME.Prior.B, fun.aggregate=sum, value.var="wt.ri", na.rm=TRUE)
write.csv(returns, "C:/Data/Thesis/25_L1ME_Prior_Returns.csv")

df %>% group_by(L1.ME.B, Prior.B, Date) %>% summarise(rp=sum(wt.ri, na.rm=TRUE)) %>%
    dcast(L1.ME.B ~ Prior.B, fun.aggregate=mean, value.var="rp", na.rm=TRUE) %>%
    select(-`NA`) %>% filter(!is.na(L1.ME.B)) %>% round(digits=2)
```

![French Website 25 $ME-Prior$ Returns](C:/Data/FrenchDartmouth/25_L1ME_Prior.JPG)

## Value and Momentum

* Monthly rebalance

```{r, warning=FALSE}
df = combine.sources(crsp, comp)
df = df %>% filter(!is.na(L1.ME), !is.na(Prior), !is.na(L13.price), !is.na(L1.ri),
                   !is.infinite(CP))
```

### Value Quintiles

```{r value.quintiles}
quantiles = 1:5/5

nyse = df %>% filter(Exchange=="NYSE") %>% select(Date, PERMNO, BMM, Prior)

breakpoints = nyse %>% arrange(Date, BMM) %>% group_by(Date) %>% summarize(
    D10=BMM[.1*n()], D20=BMM[.2*n()],
    D30=BMM[.3*n()], D40=BMM[.4*n()],
    D50=BMM[.5*n()], D60=BMM[.6*n()],
    D70=BMM[.7*n()], D80=BMM[.8*n()],
    D90=BMM[.9*n()], D100=BMM[n()]) %>% as.data.frame
# breakpoints$Period = breakpoints$Period + 1
breakpoints[, c("PERMNO", "BMM")] = NULL
df = left_join(df, breakpoints, by=c("Date"))
df = assign.bkts(df, "BMM", quantiles)
```

### $Prior$ Quintiles

```{r value.prior.quintiles}
breakpoints = nyse %>% arrange(Date, Prior) %>% group_by(Date) %>% summarize(
    D10=Prior[.1*n()], D20=Prior[.2*n()],
    D30=Prior[.3*n()], D40=Prior[.4*n()],
    D50=Prior[.5*n()], D60=Prior[.6*n()],
    D70=Prior[.7*n()], D80=Prior[.8*n()],
    D90=Prior[.9*n()], D100=Prior[n()]) %>% as.data.frame
# breakpoints$Period = breakpoints$Period + 1
breakpoints[, c("PERMNO", "Prior")] = NULL
df = left_join(df, breakpoints, by=c("Date"))
df = assign.bkts(df, "Prior", quantiles)
```

### ME

```{r}
df %>% group_by(BMM.B, Prior.B, Date) %>% summarise(Avg.ME=mean(ME, na.rm=TRUE)) %>%
    dcast(BMM.B ~ Prior.B, fun.aggregate=mean, value.var="Avg.ME", na.rm=TRUE) %>%
    select(-`NA`) %>% filter(!is.na(BMM.B)) %>% round(2)
```

### Investment

```{r}
df %>% group_by(BMM.B, Prior.B, Date) %>% summarise(Avg.INV=mean(INV, na.rm=TRUE)) %>%
    dcast(BMM.B ~ Prior.B, fun.aggregate=mean, value.var="Avg.INV", na.rm=TRUE) %>%
    select(-`NA`) %>% filter(!is.na(BMM.B)) %>% round(2)
```

### CP

```{r}
df %>% group_by(BMM.B, Prior.B, Date) %>% summarise(Avg.CP=mean(CP, na.rm=TRUE)) %>%
    dcast(BMM.B ~ Prior.B, fun.aggregate=mean, value.var="Avg.CP", na.rm=TRUE) %>%
    select(-`NA`) %>% filter(!is.na(BMM.B)) %>% round(2)
```

### Accruals

```{r}
df %>% group_by(BMM.B, Prior.B, Date) %>% summarise(Avg.Acc=mean(Acc, na.rm=TRUE)) %>%
    dcast(BMM.B ~ Prior.B, fun.aggregate=mean, value.var="Avg.Acc", na.rm=TRUE) %>%
    select(-`NA`) %>% filter(!is.na(BMM.B)) %>% round(4)
```

## $Acc$ and $INV$

* Annual rebalance

```{r, warning=FALSE}
df = combine.sources(crsp, comp)
df = df %>% filter(!is.na(Acc), !is.na(INV))
```

### $Acc$ Quintiles

```{r Acc.quintiles}
quantiles = 1:5/5

nyse = df %>% filter(Exchange=="NYSE", Month==7) %>% select(Period, PERMNO, Acc, INV)

breakpoints = nyse %>% arrange(Period, Acc) %>% group_by(Period) %>% summarize(
    D10=Acc[.1*n()], D20=Acc[.2*n()],
    D30=Acc[.3*n()], D40=Acc[.4*n()],
    D50=Acc[.5*n()], D60=Acc[.6*n()],
    D70=Acc[.7*n()], D80=Acc[.8*n()],
    D90=Acc[.9*n()], D100=Acc[n()]) %>% as.data.frame
breakpoints$Period = breakpoints$Period + 1
breakpoints[, c("PERMNO", "Acc")] = NULL
df = left_join(df, breakpoints, by=c("Period"))
df = assign.bkts(df, "Acc", quantiles)
```

### $INV$ Quintiles

```{r acc.inv.quintiles}
breakpoints = nyse %>% arrange(Period, INV) %>% group_by(Period) %>% summarize(
    D10=INV[.1*n()], D20=INV[.2*n()],
    D30=INV[.3*n()], D40=INV[.4*n()],
    D50=INV[.5*n()], D60=INV[.6*n()],
    D70=INV[.7*n()], D80=INV[.8*n()],
    D90=INV[.9*n()], D100=INV[n()]) %>% as.data.frame
breakpoints$Period = breakpoints$Period + 1
breakpoints[, c("PERMNO", "INV")] = NULL
df = left_join(df, breakpoints, by=c("Period"))
df = assign.bkts(df, "INV", quantiles)
```

```{r}
df %>% group_by(Acc.B, INV.B, Date) %>% summarize(N=n()) %>% group_by(Acc.B, INV.B) %>%
    dcast(Acc.B ~ INV.B, value.var="N", fun.aggregate=mean, na.rm=TRUE) %>%
    round(0)
```

```{r}
# df = ri.adj.Size(df)

df = df %>% group_by(Acc.B, INV.B, Date) %>% mutate(
    adj.bkt.Size=sum(adj.Size, na.rm=TRUE)
) %>% as.data.frame
df$wt.ri = df$ri * df$adj.Size / df$adj.bkt.Size
```

### Returns

```{r}
df$Acc.INV.B = interaction(df$Acc.B, df$INV.B)
df$wt.ri = df$wt.ri * 100

returns = df %>% dcast(Date ~ Acc.INV.B, fun.aggregate=sum, value.var="wt.ri", na.rm=TRUE)
write.csv(returns, "C:/Data/Thesis/25_Acc_INV_Returns.csv")

df %>% group_by(Acc.B, INV.B, Date) %>% summarise(rp=sum(wt.ri, na.rm=TRUE)) %>%
    dcast(Acc.B ~ INV.B, fun.aggregate=mean, value.var="rp", na.rm=TRUE) %>%
    select(-`NA`) %>% filter(!is.na(Acc.B)) %>% round(digits=2)
```

# Create Factors

## Market Excess Return, $R_M$

```{r rm}
rm = crsp %>% select(Date, rmkt) %>% filter(!duplicated(c(Date)))

rm$rmkt = rm$rmkt * 100
summary(rm)
```

```{r}
rf = fread("C:/Data/CRSP/RF_196307_201612.csv")
```

```{r}
rf$Date = as.Date(as.character(rf$caldt), "%Y%m%d")
rf$caldt = NULL
rf$rf = rf$t30ret * 100
rf$t30ret = NULL
summary(rf)
```

```{r}
rm = left_join(rm, rf, by=c("Date"))
```

```{r}
rm$rf[is.na(rm$rf)] = mean(rm$rf, na.rm=TRUE)
rm$rmkt[is.na(rm$rmkt)] = mean(rm$rmkt, na.rm=TRUE)
rm$Rm = rm$rmkt - rm$rf
rm = rm %>% filter(Date>as.Date("1963-06-30"))
summary(rm)

rbind(sapply(rm[,-1], mean), sapply(rm[,-1], se), sapply(rm[,-1], t.stat)) %>% round(2)
rm$rmkt = NULL
rm$rf = NULL
```

## $Size$ and $BM$

* Annual rebalance

```{r, warning=FALSE}
df = combine.sources(crsp, comp)
df = df %>% filter(!is.na(BM), !is.na(Size), BE>0)
```

```{r}
df %>% select(Date, PERMNO, Size, BM) %>% arrange(Date) %>% head
```

### $Size$ Median

```{r size.bm.median}
quantiles = 1:2/2

nyse = df %>% filter(Exchange=="NYSE", Month==7) %>% select(Period, PERMNO, Size, BM)

breakpoints = nyse %>% arrange(Period, Size) %>% group_by(Period) %>% summarize(
    D10=Size[.1*n()], D20=Size[.2*n()],
    D30=Size[.3*n()], D40=Size[.4*n()],
    D50=Size[.5*n()], D60=Size[.6*n()],
    D70=Size[.7*n()], D80=Size[.8*n()],
    D90=Size[.9*n()], D100=Size[n()]) %>% as.data.frame
breakpoints$Period = breakpoints$Period + 1
breakpoints[, c("PERMNO", "Size")] = NULL
df = left_join(df, breakpoints, by=c("Period"))
df = assign.bkts(df, "Size", quantiles)
```

### $BM$ Quantiles

```{r bm.30.70}
quantiles = c(.3, .7, 1.)

breakpoints = nyse %>% arrange(Period, BM) %>% group_by(Period) %>% summarize(
    D10=BM[.1*n()], D20=BM[.2*n()],
    D30=BM[.3*n()], D40=BM[.4*n()],
    D50=BM[.5*n()], D60=BM[.6*n()],
    D70=BM[.7*n()], D80=BM[.8*n()],
    D90=BM[.9*n()], D100=BM[n()]) %>% as.data.frame
breakpoints$Period = breakpoints$Period + 1
breakpoints[, c("PERMNO", "BM")] = NULL
df = left_join(df, breakpoints, by=c("Period"))
df = assign.bkts(df, "BM", quantiles)
```

```{r}
summary(df %>% select(Size.B, BM.B))
typeof(df$Size.B)
```

```{r}
df$Size.B = factor(df$Size.B, labels=c("S", "B"))
df$BM.B = factor(df$BM.B, labels=c("L", "M", "H"))
```

```{r}
summary(df %>% select(Size.B, BM.B))
typeof(df$Size.B)
```

```{r}
#df %>% group_by(Size.B, BM.B, Date) %>% summarize(N=n()) %>% group_by(Size.B, BM.B) %>%
#    dcast(Size.B ~ BM.B, value.var="N", fun.aggregate=mean, na.rm=TRUE)
```

```{r}
# df = ri.adj.Size(df)

df = df %>% group_by(Size.B, BM.B, Date) %>% mutate(
    adj.bkt.Size=sum(adj.Size, na.rm=TRUE)
) %>% as.data.frame
df$wt.ri = df$ri * df$adj.Size / df$adj.bkt.Size
```

### Returns

```{r}
df$Size.BM.B = interaction(df$Size.B, df$BM.B, sep="")
df$wt.ri = df$wt.ri * 100

returns = df %>% dcast(Date ~ Size.BM.B, fun.aggregate=sum, value.var="wt.ri", na.rm=TRUE)

#df %>% group_by(Size.B, BM.B, Date) %>% summarise(rp=sum(wt.ri, na.rm=TRUE)) %>%
#    dcast(Size.B ~ BM.B, fun.aggregate=mean, value.var="rp", na.rm=TRUE) %>%
#    select(-`NA`) %>% filter(!is.na(Size.B))

returns = returns %>% filter(Date>as.Date("1963-06-30"))

returns$HMLs = returns$SH - returns$SL
returns$HMLb = returns$BH - returns$BL
returns$HML = (returns$SH+returns$BH)/2 - (returns$SL+returns$BL)/2
returns$SMB.HML = ((returns$SL+returns$SM+returns$SH)/3 -
               (returns$BL+returns$BM+returns$BH)/3)
HML = returns %>% select(Date, HML, SMB.HML)

stat.summary(returns %>% select(-c(Date, `NA`))) %>% round(2)

write.csv(returns, "C:/Data/Thesis/6_Size_BM_Returns.csv")
```

![French Website 6 $Size-BM$ Returns](C:/Data/FrenchDartmouth/6_Size_BM.JPG)



## $Size$ and $BM_M$

* Monthly rebalance

```{r, warning=FALSE}
df = combine.sources(crsp, comp)
df = df %>% filter(!is.na(L1.ME), !is.na(BMM), BE>0)
```

### $Size$ Median

```{r size.bmm.median}
quantiles = 1:2/2

nyse = df %>% filter(Exchange=="NYSE") %>% select(Date, PERMNO, L1.ME, BMM)

breakpoints = nyse %>% arrange(Date, L1.ME) %>% group_by(Date) %>% summarize(
    D10=L1.ME[.1*n()], D20=L1.ME[.2*n()],
    D30=L1.ME[.3*n()], D40=L1.ME[.4*n()],
    D50=L1.ME[.5*n()], D60=L1.ME[.6*n()],
    D70=L1.ME[.7*n()], D80=L1.ME[.8*n()],
    D90=L1.ME[.9*n()], D100=L1.ME[n()]) %>% as.data.frame
# breakpoints$Period = breakpoints$Period + 1
breakpoints[, c("PERMNO", "L1.ME")] = NULL
df = left_join(df, breakpoints, by=c("Date"))
df = assign.bkts(df, "L1.ME", quantiles)
```

### $BM_M$ Quantiles

```{r bmm.quantiles}
quantiles = c(.3, .7, 1.)

breakpoints = nyse %>% arrange(Date, BMM) %>% group_by(Date) %>% summarize(
    D10=BMM[.1*n()], D20=BMM[.2*n()],
    D30=BMM[.3*n()], D40=BMM[.4*n()],
    D50=BMM[.5*n()], D60=BMM[.6*n()],
    D70=BMM[.7*n()], D80=BMM[.8*n()],
    D90=BMM[.9*n()], D100=BMM[n()]) %>% as.data.frame
# breakpoints$Period = breakpoints$Period + 1
breakpoints[, c("PERMNO", "BMM")] = NULL
df = left_join(df, breakpoints, by=c("Date"))
df = assign.bkts(df, "BMM", quantiles)
```

```{r}
df$L1.ME.B = factor(df$L1.ME.B, labels=c("S", "B"))
df$BMM.B = factor(df$BMM.B, labels=c("Lm", "Mm", "Hm"))
```

```{r}
# df = ri.adj.Size(df)

df = df %>% group_by(L1.ME.B, BMM.B, Date) %>% mutate(
    bkt.L1.ME=sum(L1.ME, na.rm=TRUE)
) %>% as.data.frame
df$wt.ri = df$ri * df$L1.ME / df$bkt.L1.ME
```

### Returns

```{r}
df$L1.ME.BMM.B = interaction(df$L1.ME.B, df$BMM.B, sep="")
df$wt.ri = df$wt.ri * 100

returns = df %>% dcast(Date ~ L1.ME.BMM.B, fun.aggregate=sum, value.var="wt.ri", na.rm=TRUE)

returns = returns %>% filter(Date>as.Date("1963-06-30"))

returns$HMLms = returns$SHm - returns$SLm
returns$HMLmb = returns$BHm - returns$BLm
returns$HMLm = (returns$SHm+returns$BHm)/2 - (returns$SLm+returns$BLm)/2
returns$SMB.HMLm = ((returns$SLm+returns$SMm+returns$SHm)/3 -
               (returns$BLm+returns$BMm+returns$BHm)/3)
HMLm = returns %>% select(Date, HMLm, SMB.HMLm)

stat.summary(returns %>% select(-c(Date, `NA`))) %>% round(2)

write.csv(returns, "C:/Data/Thesis/6_L1ME_BMM_Returns.csv")
```





## $Size$ and $OP$

* Annual rebalance

```{r, warning=FALSE}
df = combine.sources(crsp, comp)
df = df %>% filter(!is.na(Size), OP.OK)
```

### $Size$ Median

```{r size.op.median}
quantiles = 1:2/2

nyse = df %>% filter(Exchange=="NYSE", Month==7) %>% select(Period, PERMNO, Size, OP)

breakpoints = nyse %>% arrange(Period, Size) %>% group_by(Period) %>% summarize(
    D10=Size[.1*n()], D20=Size[.2*n()],
    D30=Size[.3*n()], D40=Size[.4*n()],
    D50=Size[.5*n()], D60=Size[.6*n()],
    D70=Size[.7*n()], D80=Size[.8*n()],
    D90=Size[.9*n()], D100=Size[n()]) %>% as.data.frame
breakpoints$Period = breakpoints$Period + 1
breakpoints[, c("PERMNO", "Size")] = NULL
df = left_join(df, breakpoints, by=c("Period"))
df = assign.bkts(df, "Size", quantiles)
```

### $OP$ Quantiles

```{r op.quantiles}
quantiles =c(.3, .7, 1.)

breakpoints = nyse %>% arrange(Period, OP) %>% group_by(Period) %>% summarize(
    D10=OP[.1*n()], D20=OP[.2*n()],
    D30=OP[.3*n()], D40=OP[.4*n()],
    D50=OP[.5*n()], D60=OP[.6*n()],
    D70=OP[.7*n()], D80=OP[.8*n()],
    D90=OP[.9*n()], D100=OP[n()]) %>% as.data.frame
breakpoints$Period = breakpoints$Period + 1
breakpoints[, c("PERMNO", "OP")] = NULL
df = left_join(df, breakpoints, by=c("Period"))
df = assign.bkts(df, "OP", quantiles)
```

```{r}
df$Size.B = factor(df$Size.B, labels=c("S", "B"))
df$OP.B = factor(df$OP.B, labels=c("Wo", "Mo", "Ro"))
```

```{r}
# df = ri.adj.Size(df)

df = df %>% group_by(Size.B, OP.B, Date) %>% mutate(
    adj.bkt.Size=sum(adj.Size, na.rm=TRUE)
) %>% as.data.frame
df$wt.ri = df$ri * df$adj.Size / df$adj.bkt.Size
```





### Returns

```{r}
df$Size.OP.B = interaction(df$Size.B, df$OP.B, sep="")
df$wt.ri = df$wt.ri * 100

returns = df %>% dcast(Date ~ Size.OP.B, fun.aggregate=sum, value.var="wt.ri", na.rm=TRUE)

returns = returns %>% filter(Date>as.Date("1963-06-30"))

returns$RMWos = returns$SRo - returns$SWo
returns$RMWob = returns$BRo - returns$BWo
returns$RMWo = (returns$SRo+returns$BRo)/2 - (returns$SWo+returns$BWo)/2
returns$SMB.RMWo = ((returns$SWo+returns$SMo+returns$SRo)/3 -
               (returns$BWo+returns$BMo+returns$BRo)/3)
RMWo = returns %>% select(Date, RMWo, SMB.RMWo)

stat.summary(returns %>% select(-c(Date, `NA`))) %>% round(2)

write.csv(returns, "C:/Data/Thesis/6_Size_OP_Returns.csv")
```

![French Website 6 $Size-OP$ Returns](C:/Data/FrenchDartmouth/6_Size_OP.JPG)

## $Size$ and $OP.2$

* Annual rebalance

```{r, warning=FALSE}
df = combine.sources(crsp, comp)
df = df %>% filter(!is.na(Size), OP.OK)
```

### $Size$ Median

```{r size.OP.2.median}
quantiles = 1:2/2

nyse = df %>% filter(Exchange=="NYSE", Month==7) %>% select(Period, PERMNO, Size, OP.2)

breakpoints = nyse %>% arrange(Period, Size) %>% group_by(Period) %>% summarize(
    D10=Size[.1*n()], D20=Size[.2*n()],
    D30=Size[.3*n()], D40=Size[.4*n()],
    D50=Size[.5*n()], D60=Size[.6*n()],
    D70=Size[.7*n()], D80=Size[.8*n()],
    D90=Size[.9*n()], D100=Size[n()]) %>% as.data.frame
breakpoints$Period = breakpoints$Period + 1
breakpoints[, c("PERMNO", "Size")] = NULL
df = left_join(df, breakpoints, by=c("Period"))
df = assign.bkts(df, "Size", quantiles)
```

### $OP.2$ Quantiles

```{r OP.2.quantiles}
quantiles =c(.3, .7, 1.)

breakpoints = nyse %>% arrange(Period, OP.2) %>% group_by(Period) %>% summarize(
    D10=OP.2[.1*n()], D20=OP.2[.2*n()],
    D30=OP.2[.3*n()], D40=OP.2[.4*n()],
    D50=OP.2[.5*n()], D60=OP.2[.6*n()],
    D70=OP.2[.7*n()], D80=OP.2[.8*n()],
    D90=OP.2[.9*n()], D100=OP.2[n()]) %>% as.data.frame
breakpoints$Period = breakpoints$Period + 1
breakpoints[, c("PERMNO", "OP.2")] = NULL
df = left_join(df, breakpoints, by=c("Period"))
df = assign.bkts(df, "OP.2", quantiles)
```

```{r}
df$Size.B = factor(df$Size.B, labels=c("S", "B"))
df$OP.2.B = factor(df$OP.2.B, labels=c("Wor", "Mor", "Ror"))

df = df %>% group_by(Size.B, OP.2.B, Date) %>% mutate(
    adj.bkt.Size=sum(adj.Size, na.rm=TRUE)
) %>% as.data.frame
df$wt.ri = df$ri * df$adj.Size / df$adj.bkt.Size
```





### Returns

```{r}
df$Size.OP.2.B = interaction(df$Size.B, df$OP.2.B, sep="")
df$wt.ri = df$wt.ri * 100

returns = df %>% dcast(Date ~ Size.OP.2.B, fun.aggregate=sum, value.var="wt.ri", na.rm=TRUE)

returns = returns %>% filter(Date>as.Date("1963-06-30"))

returns$RMWors = returns$SRor - returns$SWor
returns$RMWorb = returns$BRor - returns$BWor
returns$RMWor = (returns$SRor+returns$BRor)/2 - (returns$SWor+returns$BWor)/2
returns$SMB.RMWor = ((returns$SWor+returns$SMor+returns$SRor)/3 -
               (returns$BWor+returns$BMor+returns$BRor)/3)
RMWor = returns %>% select(Date, RMWor, SMB.RMWor)

stat.summary(returns %>% select(-c(Date, `NA`))) %>% round(2)

write.csv(returns, "C:/Data/Thesis/6_Size_OP_RnD_Returns.csv")
```

## $Size$ and $GP$

* Annual rebalance

```{r, warning=FALSE}
df = combine.sources(crsp, comp)
df = df %>% filter(!is.na(Size), !is.na(GP))
```

### $Size$ Median

```{r size.gp.median}
quantiles = 1:2/2

nyse = df %>% filter(Exchange=="NYSE", Month==7) %>% select(Period, PERMNO, Size, GP)

breakpoints = nyse %>% arrange(Period, Size) %>% group_by(Period) %>% summarize(
    D10=Size[.1*n()], D20=Size[.2*n()],
    D30=Size[.3*n()], D40=Size[.4*n()],
    D50=Size[.5*n()], D60=Size[.6*n()],
    D70=Size[.7*n()], D80=Size[.8*n()],
    D90=Size[.9*n()], D100=Size[n()]) %>% as.data.frame
breakpoints$Period = breakpoints$Period + 1
breakpoints[, c("PERMNO", "Size")] = NULL
df = left_join(df, breakpoints, by=c("Period"))
df = assign.bkts(df, "Size", quantiles)
```

### $GP$ Quantiles

```{r gp.quantiles}
quantiles =c(.3, .7, 1.)

breakpoints = nyse %>% arrange(Period, GP) %>% group_by(Period) %>% summarize(
    D10=GP[.1*n()], D20=GP[.2*n()],
    D30=GP[.3*n()], D40=GP[.4*n()],
    D50=GP[.5*n()], D60=GP[.6*n()],
    D70=GP[.7*n()], D80=GP[.8*n()],
    D90=GP[.9*n()], D100=GP[n()]) %>% as.data.frame
breakpoints$Period = breakpoints$Period + 1
breakpoints[, c("PERMNO", "GP")] = NULL
df = left_join(df, breakpoints, by=c("Period"))
df = assign.bkts(df, "GP", quantiles)
```

```{r}
df$Size.B = factor(df$Size.B, labels=c("S", "B"))
df$GP.B = factor(df$GP.B, labels=c("Wg", "Mg", "Rg"))
```

```{r}
# df = ri.adj.Size(df)

df = df %>% group_by(Size.B, GP.B, Date) %>% mutate(
    adj.bkt.Size=sum(adj.Size, na.rm=TRUE)
) %>% as.data.frame
df$wt.ri = df$ri * df$adj.Size / df$adj.bkt.Size
```

### Returns

```{r}
df$Size.GP.B = interaction(df$Size.B, df$GP.B, sep="")
df$wt.ri = df$wt.ri * 100

returns = df %>% dcast(Date ~ Size.GP.B, fun.aggregate=sum, value.var="wt.ri", na.rm=TRUE)

returns = returns %>% filter(Date>as.Date("1963-06-30"))

returns$RMWgs = returns$SRg - returns$SWg
returns$RMWgb = returns$BRg - returns$BWg
returns$RMWg = (returns$SRg+returns$BRg)/2 - (returns$SWg+returns$BWg)/2
returns$SMB.RMWg = ((returns$SWg+returns$SMg+returns$SRg)/3 -
               (returns$BWg+returns$BMg+returns$BRg)/3)
RMWg = returns %>% select(Date, RMWg, SMB.RMWg)

stat.summary(returns %>% select(-c(Date, `NA`))) %>% round(2)

write.csv(returns, "C:/Data/Thesis/6_Size_GP_Returns.csv")
```


## $Size$ and $CP$

* Annual rebalance

```{r, warning=FALSE}
df = combine.sources(crsp, comp)
df = df %>% filter(!is.na(Size), OP.OK)
```

### $Size$ Median

```{r size.CP.median}
quantiles = 1:2/2

nyse = df %>% filter(Exchange=="NYSE", Month==7) %>% select(Period, PERMNO, Size, CP)

breakpoints = nyse %>% arrange(Period, Size) %>% group_by(Period) %>% summarize(
    D10=Size[.1*n()], D20=Size[.2*n()],
    D30=Size[.3*n()], D40=Size[.4*n()],
    D50=Size[.5*n()], D60=Size[.6*n()],
    D70=Size[.7*n()], D80=Size[.8*n()],
    D90=Size[.9*n()], D100=Size[n()]) %>% as.data.frame
breakpoints$Period = breakpoints$Period + 1
breakpoints[, c("PERMNO", "Size")] = NULL
df = left_join(df, breakpoints, by=c("Period"))
df = assign.bkts(df, "Size", quantiles)
```

### $CP$ Quantiles

```{r CP.quantiles}
quantiles =c(.3, .7, 1.)

breakpoints = nyse %>% arrange(Period, CP) %>% group_by(Period) %>% summarize(
    D10=CP[.1*n()], D20=CP[.2*n()],
    D30=CP[.3*n()], D40=CP[.4*n()],
    D50=CP[.5*n()], D60=CP[.6*n()],
    D70=CP[.7*n()], D80=CP[.8*n()],
    D90=CP[.9*n()], D100=CP[n()]) %>% as.data.frame
breakpoints$Period = breakpoints$Period + 1
breakpoints[, c("PERMNO", "CP")] = NULL
df = left_join(df, breakpoints, by=c("Period"))
df = assign.bkts(df, "CP", quantiles)
```

```{r}
df$Size.B = factor(df$Size.B, labels=c("S", "B"))
df$CP.B = factor(df$CP.B, labels=c("Wc", "Mc", "Rc"))
```

```{r}
# df = ri.adj.Size(df)

df = df %>% group_by(Size.B, CP.B, Date) %>% mutate(
    adj.bkt.Size=sum(adj.Size, na.rm=TRUE)
) %>% as.data.frame
df$wt.ri = df$ri * df$adj.Size / df$adj.bkt.Size
```





### Returns

```{r}
df$Size.CP.B = interaction(df$Size.B, df$CP.B, sep="")
df$wt.ri = df$wt.ri * 100

returns = df %>% dcast(Date ~ Size.CP.B, fun.aggregate=sum, value.var="wt.ri", na.rm=TRUE)

returns = returns %>% filter(Date>as.Date("1963-06-30"))

returns$RMWcs = returns$SRc - returns$SWc
returns$RMWcb = returns$BRc - returns$BWc
returns$RMWc = (returns$SRc+returns$BRc)/2 - (returns$SWc+returns$BWc)/2
returns$SMB.RMWc = ((returns$SWc+returns$SMc+returns$SRc)/3 -
               (returns$BWc+returns$BMc+returns$BRc)/3)
RMWc = returns %>% select(Date, RMWc, SMB.RMWc)

stat.summary(returns %>% select(-c(Date, `NA`))) %>% round(2)

write.csv(returns, "C:/Data/Thesis/6_Size_CP_Returns.csv")
```

## $Size$ and $INV$

* Annual rebalance

### PPE

```{r, warning=FALSE}
df = combine.sources(crsp, comp)
df$INV = df$INV.ppe
df = df %>% filter(!is.na(Size), !is.na(INV))
```

### $Size$ Median

```{r size.inv.ppe.median}
quantiles = 1:2/2

nyse = df %>% filter(Exchange=="NYSE", Month==7) %>% select(Period, PERMNO, Size, INV)

breakpoints = nyse %>% arrange(Period, Size) %>% group_by(Period) %>% summarize(
    D10=Size[.1*n()], D20=Size[.2*n()],
    D30=Size[.3*n()], D40=Size[.4*n()],
    D50=Size[.5*n()], D60=Size[.6*n()],
    D70=Size[.7*n()], D80=Size[.8*n()],
    D90=Size[.9*n()], D100=Size[n()]) %>% as.data.frame
breakpoints$Period = breakpoints$Period + 1
breakpoints[, c("PERMNO", "Size")] = NULL
df = left_join(df, breakpoints, by=c("Period"))
df = assign.bkts(df, "Size", quantiles)
```

### $INV$ Quantiles

```{r inv.ppe.quantiles}
quantiles = c(.3, .7, 1.)

breakpoints = nyse %>% arrange(Period, INV) %>% group_by(Period) %>% summarize(
    D10=INV[.1*n()], D20=INV[.2*n()],
    D30=INV[.3*n()], D40=INV[.4*n()],
    D50=INV[.5*n()], D60=INV[.6*n()],
    D70=INV[.7*n()], D80=INV[.8*n()],
    D90=INV[.9*n()], D100=INV[n()]) %>% as.data.frame
breakpoints$Period = breakpoints$Period + 1
breakpoints[, c("PERMNO", "INV")] = NULL
df = left_join(df, breakpoints, by=c("Period"))
df = assign.bkts(df, "INV", quantiles)
```

```{r}
df$Size.B = factor(df$Size.B, labels=c("S", "B"))
df$INV.B = factor(df$INV.B, labels=c("C", "M", "A"))
```

```{r}
# df = ri.adj.Size(df)

df = df %>% group_by(Size.B, INV.B, Date) %>% mutate(
    adj.bkt.Size=sum(adj.Size, na.rm=TRUE)
) %>% as.data.frame
df$wt.ri = df$ri * df$adj.Size / df$adj.bkt.Size
```

### Returns

```{r}
df$Size.INV.B = interaction(df$Size.B, df$INV.B, sep="")
df$wt.ri = df$wt.ri * 100

returns = df %>% dcast(Date ~ Size.INV.B, fun.aggregate=sum, value.var="wt.ri", na.rm=TRUE)

returns = returns %>% filter(Date>as.Date("1963-06-30"))

returns$CMAs = returns$SC - returns$SA
returns$CMAb = returns$BC - returns$BA
returns$CMA = (returns$SC+returns$BC)/2 - (returns$SA+returns$BA)/2
returns$SMB.CMA = ((returns$SC+returns$SM+returns$SA)/3 -
               (returns$BC+returns$BM+returns$BA)/3)
CMA = returns %>% select(Date, CMA, SMB.CMA)

stat.summary(returns %>% select(-c(Date, `NA`))) %>% round(2)

write.csv(returns, "C:/Data/Thesis/6_Size_INV_PPE_Returns.csv")
```

### Assets

```{r, warning=FALSE}
df = combine.sources(crsp, comp)
df = df %>% filter(!is.na(Size), !is.na(INV))
```

### $Size$ Median

```{r size.inv.median}
quantiles = 1:2/2

nyse = df %>% filter(Exchange=="NYSE", Month==7) %>% select(Period, PERMNO, Size, INV)

breakpoints = nyse %>% arrange(Period, Size) %>% group_by(Period) %>% summarize(
    D10=Size[.1*n()], D20=Size[.2*n()],
    D30=Size[.3*n()], D40=Size[.4*n()],
    D50=Size[.5*n()], D60=Size[.6*n()],
    D70=Size[.7*n()], D80=Size[.8*n()],
    D90=Size[.9*n()], D100=Size[n()]) %>% as.data.frame
breakpoints$Period = breakpoints$Period + 1
breakpoints[, c("PERMNO", "Size")] = NULL
df = left_join(df, breakpoints, by=c("Period"))
df = assign.bkts(df, "Size", quantiles)
```

### $INV$ Quantiles

```{r inv.quantiles}
quantiles = c(.3, .7, 1.)

breakpoints = nyse %>% arrange(Period, INV) %>% group_by(Period) %>% summarize(
    D10=INV[.1*n()], D20=INV[.2*n()],
    D30=INV[.3*n()], D40=INV[.4*n()],
    D50=INV[.5*n()], D60=INV[.6*n()],
    D70=INV[.7*n()], D80=INV[.8*n()],
    D90=INV[.9*n()], D100=INV[n()]) %>% as.data.frame
breakpoints$Period = breakpoints$Period + 1
breakpoints[, c("PERMNO", "INV")] = NULL
df = left_join(df, breakpoints, by=c("Period"))
df = assign.bkts(df, "INV", quantiles)
```

```{r}
df$Size.B = factor(df$Size.B, labels=c("S", "B"))
df$INV.B = factor(df$INV.B, labels=c("C", "M", "A"))
```

```{r}
# df = ri.adj.Size(df)

df = df %>% group_by(Size.B, INV.B, Date) %>% mutate(
    adj.bkt.Size=sum(adj.Size, na.rm=TRUE)
) %>% as.data.frame
df$wt.ri = df$ri * df$adj.Size / df$adj.bkt.Size
```

### Returns

```{r}
df$Size.INV.B = interaction(df$Size.B, df$INV.B, sep="")
df$wt.ri = df$wt.ri * 100

returns = df %>% dcast(Date ~ Size.INV.B, fun.aggregate=sum, value.var="wt.ri", na.rm=TRUE)

returns = returns %>% filter(Date>as.Date("1963-06-30"))

returns$CMAs = returns$SC - returns$SA
returns$CMAb = returns$BC - returns$BA
returns$CMA = (returns$SC+returns$BC)/2 - (returns$SA+returns$BA)/2
returns$SMB.CMA = ((returns$SC+returns$SM+returns$SA)/3 -
               (returns$BC+returns$BM+returns$BA)/3)
CMA = returns %>% select(Date, CMA, SMB.CMA)

stat.summary(returns %>% select(-c(Date, `NA`))) %>% round(2)

write.csv(returns, "C:/Data/Thesis/6_Size_INV_Returns.csv")
```

![French Website 6 $Size-INV$ Returns](C:/Data/FrenchDartmouth/6_Size_INV.JPG)





## $Size$ and $Prior$

* Monthly rebalance

```{r, warning=FALSE}
df = combine.sources(crsp, comp)
df = df %>% filter(!is.na(L1.ME), !is.na(Prior), !is.na(L13.price), !is.na(L1.ri))
```

### $Size$ Median

```{r size.prior.median}
quantiles = 1:2/2

nyse = df %>% filter(Exchange=="NYSE") %>% select(Date, PERMNO, L1.ME, Prior)

breakpoints = nyse %>% arrange(Date, L1.ME) %>% group_by(Date) %>% summarize(
    D10=L1.ME[.1*n()], D20=L1.ME[.2*n()],
    D30=L1.ME[.3*n()], D40=L1.ME[.4*n()],
    D50=L1.ME[.5*n()], D60=L1.ME[.6*n()],
    D70=L1.ME[.7*n()], D80=L1.ME[.8*n()],
    D90=L1.ME[.9*n()], D100=L1.ME[n()]) %>% as.data.frame
# breakpoints$Period = breakpoints$Period + 1
breakpoints[, c("PERMNO", "L1.ME")] = NULL
df = left_join(df, breakpoints, by=c("Date"))
df = assign.bkts(df, "L1.ME", quantiles)
```

### $Prior$ Quantiles

```{r prior.quantiles}
quantiles = c(.3, .7, 1.)

breakpoints = nyse %>% arrange(Date, Prior) %>% group_by(Date) %>% summarize(
    D10=Prior[.1*n()], D20=Prior[.2*n()],
    D30=Prior[.3*n()], D40=Prior[.4*n()],
    D50=Prior[.5*n()], D60=Prior[.6*n()],
    D70=Prior[.7*n()], D80=Prior[.8*n()],
    D90=Prior[.9*n()], D100=Prior[n()]) %>% as.data.frame
# breakpoints$Period = breakpoints$Period + 1
breakpoints[, c("PERMNO", "Prior")] = NULL
df = left_join(df, breakpoints, by=c("Date"))
df = assign.bkts(df, "Prior", quantiles)
```

```{r}
df$L1.ME.B = factor(df$L1.ME.B, labels=c("S", "B"))
df$Prior.B = factor(df$Prior.B, labels=c("L", "M", "W"))
```

```{r}
# df = ri.adj.Size(df)

df = df %>% group_by(L1.ME.B, Prior.B, Date) %>% mutate(
    bkt.L1.ME=sum(L1.ME, na.rm=TRUE)
) %>% as.data.frame
df$wt.ri = df$ri * df$L1.ME / df$bkt.L1.ME
```

### Returns

```{r}
df$L1.ME.Prior.B = interaction(df$L1.ME.B, df$Prior.B, sep="")
df$wt.ri = df$wt.ri * 100

returns = df %>% dcast(Date ~ L1.ME.Prior.B, fun.aggregate=sum, value.var="wt.ri", na.rm=TRUE)

returns$WMLs = returns$SW - returns$SL
returns$WMLb = returns$BW - returns$BL
returns$WML = (returns$SW+returns$BW)/2 - (returns$SL+returns$BL)/2
returns$SMB.WML = ((returns$SL+returns$SM+returns$SW)/3 -
               (returns$BL+returns$BM+returns$BW)/3)
WML = returns %>% select(Date, WML, SMB.WML)

stat.summary(returns %>% select(-c(Date, `NA`))) %>% round(2)

write.csv(returns, "C:/Data/Thesis/25_L1ME_Prior_Returns.csv")
```

![French Website 6 $Size-Prior$ Returns](C:/Data/FrenchDartmouth/6_Size_Prior.JPG)





# Summarise Factors

```{r}
f = left_join(HML, HMLm, by="Date")
f = left_join(f, RMWo, by="Date")
f = left_join(f, RMWor, by="Date")
f = left_join(f, RMWg, by="Date")
f = left_join(f, RMWc, by="Date")
f = left_join(f, CMA, by="Date")
f = left_join(f, WML, by="Date")
f = left_join(f, rm, by="Date")
f$SMB = (f$SMB.HML + f$SMB.RMWo + f$SMB.CMA) / 3

stat.summary(
    f %>% select(
        -c(Date, SMB.HML, SMB.HMLm, SMB.RMWo, SMB.RMWor, SMB.RMWc, SMB.RMWg, SMB.CMA, SMB.WML)
    )
) %>% round(2)

write.csv(f, "C:/Data/Thesis/factors.csv")
```

```{r}
cor(
    f %>% select(
        -c(Date, SMB.HML, SMB.HMLm, SMB.RMWo, SMB.RMWor, SMB.RMWg, SMB.CMA, SMB.WML)
    )
) %>% round(2) %>% as.data.frame
```


# Asness and Frazzini (2013) Exhibit 6 Regression 1

```{r}
summary(lm(HML~Rm+SMB+HMLm+WML, data=f))
```

```{r}
summary(lm(HMLm~Rm+SMB+WML, data=f))
```

```{r}
summary(lm(HMLm~Rm+SMB+HML+WML, data=f))
```

# Asness and Frazzini (2013) Exhibit 6 Regression 4

```{r}
summary(lm(HMLm~Rm+SMB+HML+WML, data=f))
```

