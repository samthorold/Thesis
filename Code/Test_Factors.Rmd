---
title: "Test Factors"
author: "Sam Thorold"
output:
  html_document:
    keep_md: true
    df_print: paged
    code_folding: show
    toc: true
    toc_float: true
    number_sections: true
---

```{r setup}
knitr::opts_chunk$set(echo = TRUE, fig.height=4)
```

# Definitions and Links

- **[Variables](http://mba.tuck.dartmouth.edu/pages/faculty/ken.french/Data_Library/variable_definitions.html)**
- **[Factors](http://mba.tuck.dartmouth.edu/pages/faculty/ken.french/Data_Library/f-f_5_factors_2x3.html)**


- [Size breakpoints](http://mba.tuck.dartmouth.edu/pages/faculty/ken.french/Data_Library/det_me_breakpoints.html)
- [Size returns](http://mba.tuck.dartmouth.edu/pages/faculty/ken.french/Data_Library/det_port_form_sz.html)


- [Book-to-Market breakpoints](http://mba.tuck.dartmouth.edu/pages/faculty/ken.french/Data_Library/det_beme_breakpoints.html)
- [Book-to-Market returns](http://mba.tuck.dartmouth.edu/pages/faculty/ken.french/Data_Library/det_form_btm.html)


- [Operating Profit breakpoints](http://mba.tuck.dartmouth.edu/pages/faculty/ken.french/Data_Library/det_op_breakpoints.html)
- [Operating Profit returns](http://mba.tuck.dartmouth.edu/pages/faculty/ken.french/Data_Library/det_port_form_op.html)


- [Investment breakpoints](http://mba.tuck.dartmouth.edu/pages/faculty/ken.french/Data_Library/det_inv_breakpoints.html)
- [Investment returns](http://mba.tuck.dartmouth.edu/pages/faculty/ken.french/Data_Library/det_port_form_inv.html)


- [Momentum breakpoints](http://mba.tuck.dartmouth.edu/pages/faculty/ken.french/Data_Library/det_2-12_breakpoints.html)
- [Momentum returns](http://mba.tuck.dartmouth.edu/pages/faculty/ken.french/Data_Library/det_10_port_form_pr_12_2.html)

```{r libraries, message=FALSE, warning=FALSE}
library(data.table)
library(dplyr)
library(dtplyr)
library(ggplot2)
library(knitr)
library(pander)
library(rlang)
library(Rsolnp)
library(stargazer)
```

```{r define.stats.helpers}
se = function(x) sd(x, na.rm=TRUE)/sqrt(length(x))

t.stat = function(x) t.test(x)$statistic

sr = function(x) mean(x, na.rm=TRUE) / sd(x, na.rm=TRUE)

stat.summary = function(df){
    stat.summ = rbind(sapply(df, mean), sapply(df, se), sapply(df, t.stat), sapply(df, sr))
    row.names(stat.summ) = c("Mean", "StdErr", "t-Stat", "Sh")
    return(stat.summ)
}
```

```{r}
i = 1    # 1963-07
j = 630  # 2015-12
```

# My Factors

```{r}
f = fread("C:/Data/Thesis/factors.csv")

colnames(f)

f = f[i:j,]  %>% select(
    -c(V1, Date, SMB.HML, SMB.HMLm, SMB.RMWo, SMB.RMWor, SMB.RMWg, SMB.RMWc, SMB.CMA, SMB.WML)
)

round(stat.summary(f), 2)
```

# French Dartmouth Web Factors

```{r}
ff = fread("C:/Data/FrenchDartmouth/French_6_Factors_2x3.csv")
summary(ff)
ff = ff[i:j,] %>% select(-c(Month))
setnames(ff,
         c("Rm", "SMB", "HML", "RMW", "CMA", "WML"),
         c("FF.Rm", "FF.SMB", "FF.HML", "FF.RMW", "FF.CMA", "FF.WML"))

round(stat.summary(ff), 2)
```

```{r}
f = cbind(f, ff)  # i:j
```

```{r}
fit = lm(FF.HML~FF.Rm+FF.SMB+FF.RMW+FF.CMA, data=f)
round(as.data.frame(coef(summary(fit))), 2)

f$HMLo = fit$residuals

fit = lm(FF.HML~FF.Rm+FF.SMB+RMWor+FF.CMA, data=f)
round(as.data.frame(coef(summary(fit))), 2)

fit = lm(FF.HML~FF.Rm+FF.SMB+RMWg+FF.CMA, data=f)
round(as.data.frame(coef(summary(fit))), 2)

fit = lm(FF.HML~FF.Rm+FF.SMB+RMWc+FF.CMA, data=f)
round(as.data.frame(coef(summary(fit))), 2)
```

# Factor Correlation

```{r}
cor(f) %>% round(2)
```

# Spanning Regressions

Regressing CMA on the other factors shows that the intercept, size and profitability are insignificant.
The market is significant but the coefficient is small.
Value and momentum are significant and their coefficients are greater than 0.2.
The combination of value and momentum absorbs the information in the investment factor.

```{r}
fit = lm(FF.CMA~FF.Rm+FF.SMB+HMLm+RMWc+FF.WML, data=f)
round(coef(summary(fit)), 2)
#rbind(coef(summary(fit))[,1], coef(summary(fit))[,3]) %>% round(2)
```

```{r}
fit = lm(FF.CMA~FF.Rm+FF.SMB+HMLm+RMWg+WML, data=f)
round(coef(summary(fit)), 2)
#rbind(coef(summary(fit))[,1], coef(summary(fit))[,3]) %>% round(2)
```

```{r}
fit = lm(FF.CMA~FF.Rm+FF.SMB+FF.HML+RMWc, data=f)
round(coef(summary(fit)), 2)
#rbind(coef(summary(fit))[,1], coef(summary(fit))[,3]) %>% round(2)
```

```{r}
fit = lm(FF.CMA~FF.Rm+FF.SMB+FF.HML+RMWc+FF.WML, data=f)
round(coef(summary(fit)), 2)
#rbind(coef(summary(fit))[,1], coef(summary(fit))[,3]) %>% round(2)
```

```{r}
fit = lm(RMWc~FF.Rm+FF.SMB+FF.HML+RMWor+FF.CMA, data=f)
round(coef(summary(fit)), 2)
#rbind(coef(summary(fit))[,1], coef(summary(fit))[,3]) %>% round(2)
```

```{r}
fit = lm(RMWc~FF.Rm+FF.SMB+FF.HML+FF.RMW+FF.CMA, data=f)
round(coef(summary(fit)), 2)
#rbind(coef(summary(fit))[,1], coef(summary(fit))[,3]) %>% round(2)
```

```{r}
fit = lm(RMWg~FF.Rm+FF.SMB+FF.HML+FF.RMW+FF.CMA, data=f)
round(coef(summary(fit)), 2)
#rbind(coef(summary(fit))[,1], coef(summary(fit))[,3]) %>% round(2)
```

```{r}
fit = lm(RMWg~FF.Rm+FF.SMB+FF.HML+RMWor+FF.CMA, data=f)
round(coef(summary(fit)), 2)
#rbind(coef(summary(fit))[,1], coef(summary(fit))[,3]) %>% round(2)
```

```{r}
fit = lm(RMWg~FF.Rm+FF.SMB+FF.HML+RMWc+FF.CMA, data=f)
round(coef(summary(fit)), 2)
#rbind(coef(summary(fit))[,1], coef(summary(fit))[,3]) %>% round(2)
```

```{r}
fit = lm(WML~FF.Rm+FF.SMB+FF.HML+FF.RMW+FF.CMA, data=f)
round(coef(summary(fit)), 2)
#rbind(coef(summary(fit))[,1], coef(summary(fit))[,3]) %>% round(2)
```

```{r}
fit = lm(WML~FF.Rm+FF.SMB+FF.HML+RMWc+FF.CMA, data=f)
round(coef(summary(fit)), 2)
#rbind(coef(summary(fit))[,1], coef(summary(fit))[,3]) %>% round(2)
```

```{r}
fit = lm(WML~FF.Rm+FF.SMB+HMLm+RMWc+FF.CMA, data=f)
round(coef(summary(fit)), 2)
#rbind(coef(summary(fit))[,1], coef(summary(fit))[,3]) %>% round(2)
```

```{r}
fit = lm(WML~FF.Rm+FF.SMB+HMLm+RMWg+FF.CMA, data=f)
round(coef(summary(fit)), 2)
#rbind(coef(summary(fit))[,1], coef(summary(fit))[,3]) %>% round(2)
```

```{r}
fit = lm(WML~FF.Rm+FF.SMB+HMLm+RMWg, data=f)
round(coef(summary(fit)), 2)
#rbind(coef(summary(fit))[,1], coef(summary(fit))[,3]) %>% round(2)
```

```{r}
fit = lm(FF.HML~FF.Rm+FF.SMB+FF.RMW+FF.CMA, data=f)
round(coef(summary(fit)), 2)
#rbind(coef(summary(fit))[,1], coef(summary(fit))[,3]) %>% round(2)
```

```{r}
fit = lm(FF.HML~FF.Rm+FF.SMB+RMWc+FF.CMA, data=f)
round(coef(summary(fit)), 2)
#rbind(coef(summary(fit))[,1], coef(summary(fit))[,3]) %>% round(2)
```

```{r}
fit = lm(HMLm~FF.Rm+FF.SMB+FF.RMW+FF.CMA, data=f)
round(coef(summary(fit)), 2)
#rbind(coef(summary(fit))[,1], coef(summary(fit))[,3]) %>% round(2)
```

```{r}
fit = lm(HMLm~FF.Rm+FF.SMB+FF.RMW+FF.CMA+WML, data=f)
round(coef(summary(fit)), 2)
#rbind(coef(summary(fit))[,1], coef(summary(fit))[,3]) %>% round(2)
```

```{r}
fit = lm(HMLm~FF.Rm+FF.SMB+RMWc+FF.CMA+WML, data=f)
round(coef(summary(fit)), 2)
#rbind(coef(summary(fit))[,1], coef(summary(fit))[,3]) %>% round(2)
```

```{r}
fit = lm(HMLm~FF.Rm+FF.SMB+FF.HML+RMWc+FF.CMA+WML, data=f)
round(coef(summary(fit)), 2)
#rbind(coef(summary(fit))[,1], coef(summary(fit))[,3]) %>% round(2)
```

```{r}
fit = lm(RMWc~FF.Rm+FF.SMB+FF.HML+FF.RMW+RMWg+FF.CMA+WML, data=f)
round(coef(summary(fit)), 2)
#rbind(coef(summary(fit))[,1], coef(summary(fit))[,3]) %>% round(2)
```

```{r}
fit = lm(RMWc~FF.Rm+FF.SMB+FF.HML+HMLm+FF.RMW+RMWor+RMWg+FF.CMA+WML, data=f)
round(coef(summary(fit)), 2)
#rbind(coef(summary(fit))[,1], coef(summary(fit))[,3]) %>% round(2)
```

```{r}
fit = lm(RMWg~FF.Rm+FF.SMB+FF.HML+HMLm+FF.RMW+RMWor+RMWc+FF.CMA+WML, data=f)
round(coef(summary(fit)), 2)
#rbind(coef(summary(fit))[,1], coef(summary(fit))[,3]) %>% round(2)
```

```{r}
fit = lm(RMWor~FF.Rm+FF.SMB+FF.HML+HMLm+FF.RMW+RMWg+RMWc+FF.CMA+WML, data=f)
round(coef(summary(fit)), 2)
#rbind(coef(summary(fit))[,1], coef(summary(fit))[,3]) %>% round(2)
```

```{r}
fit = lm(HMLm~FF.Rm+FF.SMB+FF.HML+FF.RMW+RMWor+RMWg+RMWc+FF.CMA+WML, data=f)
round(coef(summary(fit)), 2)
#rbind(coef(summary(fit))[,1], coef(summary(fit))[,3]) %>% round(2)
```

```{r}
fit = lm(WML~FF.Rm+FF.SMB+FF.HML+FF.RMW+RMWor+RMWg+RMWc+FF.CMA, data=f)
round(coef(summary(fit)), 2)
#rbind(coef(summary(fit))[,1], coef(summary(fit))[,3]) %>% round(2)
```

```{r}
fit = lm(WML~FF.Rm+FF.SMB+FF.HML+HMLm+FF.RMW+RMWor+RMWg+RMWc+FF.CMA, data=f)
round(coef(summary(fit)), 2)
#rbind(coef(summary(fit))[,1], coef(summary(fit))[,3]) %>% round(2)
```

```{r}
fit = lm(FF.CMA~FF.Rm, data=f)
round(coef(summary(fit)), 2)
#rbind(coef(summary(fit))[,1], coef(summary(fit))[,3]) %>% round(2)
```

```{r}
fit = lm(FF.CMA~RMWc, data=f)
round(coef(summary(fit)), 2)
#rbind(coef(summary(fit))[,1], coef(summary(fit))[,3]) %>% round(2)
```

```{r}
fit = lm(FF.CMA~FF.Rm+RMWc, data=f)
round(coef(summary(fit)), 2)
#rbind(coef(summary(fit))[,1], coef(summary(fit))[,3]) %>% round(2)
```

```{r}
fit = lm(FF.CMA~WML, data=f)
round(coef(summary(fit)), 2)
#rbind(coef(summary(fit))[,1], coef(summary(fit))[,3]) %>% round(2)
```

```{r}
fit = lm(FF.CMA~HMLm, data=f)
round(coef(summary(fit)), 2)
#rbind(coef(summary(fit))[,1], coef(summary(fit))[,3]) %>% round(2)
```

```{r}
fit = lm(FF.CMA~HMLm+WML, data=f)
round(coef(summary(fit)), 2)
#rbind(coef(summary(fit))[,1], coef(summary(fit))[,3]) %>% round(2)
```

```{r}
fit = lm(FF.CMA~FF.Rm+HMLm+WML, data=f)
round(coef(summary(fit)), 2)
#rbind(coef(summary(fit))[,1], coef(summary(fit))[,3]) %>% round(2)
```

```{r}
fit = lm(FF.CMA~FF.Rm+FF.SMB+HMLm+WML, data=f)
round(coef(summary(fit)), 2)
#rbind(coef(summary(fit))[,1], coef(summary(fit))[,3]) %>% round(2)
```

```{r}
fit = lm(FF.CMA~FF.Rm+FF.SMB+HMLm+RMWc+WML, data=f)
round(coef(summary(fit)), 2)
#rbind(coef(summary(fit))[,1], coef(summary(fit))[,3]) %>% round(2)
```

# Useless CMA

```{r, results='asis'}
fit1 = lm(CMA ~ FF.Rm, data=f)
fit2 = lm(CMA ~ RMWc, data=f)
fit3 = lm(CMA ~ FF.Rm + RMWc, data=f)

fit4 = lm(CMA ~ HMLm, data=f)
fit5 = lm(CMA ~ FF.WML, data=f)
fit6 = lm(CMA ~ HMLm + FF.WML, data=f)

fit7 = lm(CMA ~ FF.HML, data=f)
fit8 = lm(CMA ~ FF.HML + FF.WML, data=f)

fit9 = lm(CMA ~ FF.Rm + FF.SMB + HMLm + RMWc + FF.WML, data=f)
fit10 = lm(CMA ~ FF.Rm + FF.SMB + FF.HML + RMWc + FF.WML, data=f)
```

```{r}
pander(list(m1=fit6, m2=fit9))
```

```{r}
stargazer(fit1, fit2, fit3, fit4, fit5, fit6, fit7, fit8, fit9, fit10,
          type="text", keep.stat=c("n", "rsq"), report="vcs",
          order=c(7, 1, 2, 6, 4, 3, 5))
```

```{r}
stargazer(fit4, fit5, fit6, fit9,
          type="text", keep.stat=c("n", "rsq"), report="vcs",
          order=c(6, 1, 2, 3, 4, 5))
```

```{r, results='asis'}
stargazer(fit1, fit2, fit3, fit4, fit5, fit6, fit7, fit8, fit9, fit10,
          type="html", keep.stat=c("n", "rsq"), report="vcs",
          order=c(7, 1, 2, 6, 4, 3, 5))
```

# Maximum Sharpe Ratio

$$
E(R_p) = w^T R
$$

```{r}
ER = function(w, R) t(w)%*%R
```

$$
Var(R_p) = w^T \Omega w
$$

```{r}
VAR = function(w, covar.mat) t(w)%*%covar.mat%*%w
SD = function(w, covar.mat) sqrt(VAR(w, covar.mat))
```

```{r}
# Objective function passed to one of R's minimizing thingies
SR.obj = function(w, factor.mat, covar.mat){

    w = matrix(w, nrow=length(w), ncol=1)

    R = matrix(colMeans(factor.mat), nrow=length(w), ncol=1)
    # -ve sign because we want to maximize and most optimizers minimize
    Rp = -ER(w, R)

    stdev = SD(w, covar.mat)

    return(Rp/stdev)
}
```

```{r}
SR.sq.mat = function(R, covar.mat) t(R)%*%solve(covar.mat)%*%R
```

```{r}
w.star.mat = function(Rp, R, covar.mat){
    return(((Rp/(SR.sq.mat(R, covar.mat)))[1])*solve(covar.mat)%*%R)
}
```

```{r}
# The objective function and the constraint function have to take the same
# arguments
sum.constraint = function(w, factor.mat, covar.mat){
    return(sum(w))
}
```

# Fama and French (2016) Table 3

## Rm, SMB, HML, RMWor, CMA

```{r}
factor.mat = f %>% select(FF.Rm, FF.SMB, FF.HML, RMWor, FF.CMA)
factor.mat = factor.mat

R = matrix(colMeans(factor.mat), nrow=ncol(factor.mat), ncol=1)
covar.mat = cov(factor.mat)

# Max Sharpe Ratio
Sh2 = rbind(SR.sq.mat(R, covar.mat), sqrt(SR.sq.mat(R, covar.mat)[1]))[1]

# Marginal contributions from spanning regression

fit = lm(FF.Rm ~ FF.SMB + FF.HML + RMWor + FF.CMA, data=factor.mat)
# round(coef(fit), 3)
# round(sd(fit$residuals), 3)
Mkt = (coef(fit)["(Intercept)"] / sd(fit$residuals))^2

fit = lm(FF.SMB ~ FF.Rm + FF.HML + RMWor + FF.CMA, data=factor.mat)
# round(coef(fit), 3)
# round(sd(fit$residuals), 3)
Size = (coef(fit)["(Intercept)"] / sd(fit$residuals))^2

fit = lm(FF.HML ~ FF.Rm + FF.SMB + RMWor + FF.CMA, data=factor.mat)
# round(coef(fit), 3)
# round(sd(fit$residuals), 3)
Val = (coef(fit)["(Intercept)"] / sd(fit$residuals))^2

fit = lm(RMWor ~ FF.Rm + FF.SMB + FF.HML + FF.CMA, data=factor.mat)
# round(coef(fit), 3)
# round(sd(fit$residuals), 3)
Prof = (coef(fit)["(Intercept)"] / sd(fit$residuals))^2

fit = lm(FF.CMA ~ FF.Rm + FF.SMB + FF.HML + RMWor, data=factor.mat)
# round(coef(fit), 3)
# round(sd(fit$residuals), 3)
Inv = (coef(fit)["(Intercept)"] / sd(fit$residuals))^2

RMWor = cbind(Sh2, Mkt, Size, Val, Prof, Inv)
rownames(RMWor) = c("Mkt, SMB, HML, RMWor, CMA")
# round(RMWor, 3)
```

## Rm, SMB, HML, RMWc, CMA

```{r}
factor.mat = f %>% select(FF.Rm, FF.SMB, FF.HML, RMWc, FF.CMA)
factor.mat = factor.mat

R = matrix(colMeans(factor.mat), nrow=ncol(factor.mat), ncol=1)
covar.mat = cov(factor.mat)

# Max Sharpe Ratio
Sh2 = rbind(SR.sq.mat(R, covar.mat), sqrt(SR.sq.mat(R, covar.mat)[1]))[1]

# Marginal contributions from spanning regression

fit = lm(FF.Rm ~ FF.SMB + FF.HML + RMWc + FF.CMA, data=factor.mat)
Mkt = (coef(fit)["(Intercept)"] / sd(fit$residuals))^2

fit = lm(FF.SMB ~ FF.Rm + FF.HML + RMWc + FF.CMA, data=factor.mat)
Size = (coef(fit)["(Intercept)"] / sd(fit$residuals))^2

fit = lm(FF.HML ~ FF.Rm + FF.SMB + RMWc + FF.CMA, data=factor.mat)
Val = (coef(fit)["(Intercept)"] / sd(fit$residuals))^2

fit = lm(RMWc ~ FF.Rm + FF.SMB + FF.HML + FF.CMA, data=factor.mat)
Prof = (coef(fit)["(Intercept)"] / sd(fit$residuals))^2

fit = lm(FF.CMA ~ FF.Rm + FF.SMB + FF.HML + RMWc, data=factor.mat)
Inv = (coef(fit)["(Intercept)"] / sd(fit$residuals))^2

RMWc = cbind(Sh2, Mkt, Size, Val, Prof, Inv)
rownames(RMWc) = c("Mkt, SMB, HML, RMWc, CMA")
res = rbind(RMWor, RMWc)
# round(res, 3)
```

## Rm, SMB, HML, RMWg, CMA

```{r}
factor.mat = f %>% select(FF.Rm, FF.SMB, FF.HML, RMWg, FF.CMA)
factor.mat = factor.mat

R = matrix(colMeans(factor.mat), nrow=ncol(factor.mat), ncol=1)
covar.mat = cov(factor.mat)

# Max Sharpe Ratio
Sh2 = rbind(SR.sq.mat(R, covar.mat), sqrt(SR.sq.mat(R, covar.mat)[1]))[1]

# Marginal contributions from spanning regression

fit = lm(FF.Rm ~ FF.SMB + FF.HML + RMWg + FF.CMA, data=factor.mat)
Mkt = (coef(fit)["(Intercept)"] / sd(fit$residuals))^2

fit = lm(FF.SMB ~ FF.Rm + FF.HML + RMWg + FF.CMA, data=factor.mat)
Size = (coef(fit)["(Intercept)"] / sd(fit$residuals))^2

fit = lm(FF.HML ~ FF.Rm + FF.SMB + RMWg + FF.CMA, data=factor.mat)
Val = (coef(fit)["(Intercept)"] / sd(fit$residuals))^2

fit = lm(RMWg ~ FF.Rm + FF.SMB + FF.HML + FF.CMA, data=factor.mat)
Prof = (coef(fit)["(Intercept)"] / sd(fit$residuals))^2

fit = lm(FF.CMA ~ FF.Rm + FF.SMB + FF.HML + RMWg, data=factor.mat)
Inv = (coef(fit)["(Intercept)"] / sd(fit$residuals))^2

RMWg = cbind(Sh2, Mkt, Size, Val, Prof, Inv)
rownames(RMWg) = c("Mkt, SMB, HML, RMWg, CMA")
res = rbind(RMWor, RMWc, RMWg)
# round(res, 3)
```

## Rm, SMB, HML, RMWor, CMA, WML

```{r}
factor.mat = f %>% select(FF.Rm, FF.SMB, FF.HML, RMWor, FF.CMA, WML)
factor.mat = factor.mat

R = matrix(colMeans(factor.mat), nrow=ncol(factor.mat), ncol=1)
covar.mat = cov(factor.mat)

# Max Sharpe Ratio
Sh2 = rbind(SR.sq.mat(R, covar.mat), sqrt(SR.sq.mat(R, covar.mat)[1]))[1]

# Marginal contributions from spanning regression

fit = lm(FF.Rm ~ FF.SMB + FF.HML + RMWor + FF.CMA + WML, data=factor.mat)
# round(coef(fit), 3)
# round(sd(fit$residuals), 3)
Mkt = (coef(fit)["(Intercept)"] / sd(fit$residuals))^2

fit = lm(FF.SMB ~ FF.Rm + FF.HML + RMWor + FF.CMA + WML, data=factor.mat)
# round(coef(fit), 3)
# round(sd(fit$residuals), 3)
Size = (coef(fit)["(Intercept)"] / sd(fit$residuals))^2

fit = lm(FF.HML ~ FF.Rm + FF.SMB + RMWor + FF.CMA + WML, data=factor.mat)
# round(coef(fit), 3)
# round(sd(fit$residuals), 3)
Val = (coef(fit)["(Intercept)"] / sd(fit$residuals))^2

fit = lm(RMWor ~ FF.Rm + FF.SMB + FF.HML + FF.CMA + WML, data=factor.mat)
# round(coef(fit), 3)
# round(sd(fit$residuals), 3)
Prof = (coef(fit)["(Intercept)"] / sd(fit$residuals))^2

fit = lm(FF.CMA ~ FF.Rm + FF.SMB + FF.HML + RMWor + WML, data=factor.mat)
# round(coef(fit), 3)
# round(sd(fit$residuals), 3)
Inv = (coef(fit)["(Intercept)"] / sd(fit$residuals))^2

fit = lm(WML ~ FF.Rm + FF.SMB + FF.HML + RMWor + FF.CMA, data=factor.mat)
# round(coef(fit), 3)
# round(sd(fit$residuals), 3)
Mom = (coef(fit)["(Intercept)"] / sd(fit$residuals))^2

RMWor = cbind(Sh2, Mkt, Size, Val, Prof, Inv, Mom)
rownames(RMWor) = c("Mkt, SMB, HML, RMWor, CMA, WML")
res = rbind(cbind(res, NA), RMWor)
colnames(res) = c("Sh2", "Mkt", "Size", "Val", "Prof", "Inv", "Mom")
# round(res, 3)
```

## Rm, SMB, HML, RMWc, CMA, WML

```{r}
factor.mat = f %>% select(FF.Rm, FF.SMB, FF.HML, RMWc, FF.CMA, WML)
factor.mat = factor.mat

R = matrix(colMeans(factor.mat), nrow=ncol(factor.mat), ncol=1)
covar.mat = cov(factor.mat)

# Max Sharpe Ratio
Sh2 = rbind(SR.sq.mat(R, covar.mat), sqrt(SR.sq.mat(R, covar.mat)[1]))[1]

# Marginal contributions from spanning regression

fit = lm(FF.Rm ~ FF.SMB + FF.HML + RMWc + FF.CMA + WML, data=factor.mat)
Mkt = (coef(fit)["(Intercept)"] / sd(fit$residuals))^2

fit = lm(FF.SMB ~ FF.Rm + FF.HML + RMWc + FF.CMA + WML, data=factor.mat)
Size = (coef(fit)["(Intercept)"] / sd(fit$residuals))^2

fit = lm(FF.HML ~ FF.Rm + FF.SMB + RMWc + FF.CMA + WML, data=factor.mat)
Val = (coef(fit)["(Intercept)"] / sd(fit$residuals))^2

fit = lm(RMWc ~ FF.Rm + FF.SMB + FF.HML + FF.CMA + WML, data=factor.mat)
Prof = (coef(fit)["(Intercept)"] / sd(fit$residuals))^2

fit = lm(FF.CMA ~ FF.Rm + FF.SMB + FF.HML + RMWc + WML, data=factor.mat)
Inv = (coef(fit)["(Intercept)"] / sd(fit$residuals))^2

fit = lm(WML ~ FF.Rm + FF.SMB + FF.HML + RMWc + FF.CMA, data=factor.mat)
Mom = (coef(fit)["(Intercept)"] / sd(fit$residuals))^2

RMWc = cbind(Sh2, Mkt, Size, Val, Prof, Inv, Mom)
rownames(RMWc) = c("Mkt, SMB, HML, RMWc, CMA, WML")
res = rbind(res, RMWc)
# round(res, 3)
```

## Rm, SMB, HML, RMWg, CMA, WML

```{r}
factor.mat = f %>% select(FF.Rm, FF.SMB, FF.HML, RMWg, FF.CMA, WML)
factor.mat = factor.mat

R = matrix(colMeans(factor.mat), nrow=ncol(factor.mat), ncol=1)
covar.mat = cov(factor.mat)

# Max Sharpe Ratio
Sh2 = rbind(SR.sq.mat(R, covar.mat), sqrt(SR.sq.mat(R, covar.mat)[1]))[1]

# Marginal contributions from spanning regression

fit = lm(FF.Rm ~ FF.SMB + FF.HML + RMWg + FF.CMA + WML, data=factor.mat)
Mkt = (coef(fit)["(Intercept)"] / sd(fit$residuals))^2

fit = lm(FF.SMB ~ FF.Rm + FF.HML + RMWg + FF.CMA + WML, data=factor.mat)
Size = (coef(fit)["(Intercept)"] / sd(fit$residuals))^2

fit = lm(FF.HML ~ FF.Rm + FF.SMB + RMWg + FF.CMA + WML, data=factor.mat)
Val = (coef(fit)["(Intercept)"] / sd(fit$residuals))^2

fit = lm(RMWg ~ FF.Rm + FF.SMB + FF.HML + FF.CMA + WML, data=factor.mat)
Prof = (coef(fit)["(Intercept)"] / sd(fit$residuals))^2

fit = lm(FF.CMA ~ FF.Rm + FF.SMB + FF.HML + RMWg + WML, data=factor.mat)
Inv = (coef(fit)["(Intercept)"] / sd(fit$residuals))^2

fit = lm(WML ~ FF.Rm + FF.SMB + FF.HML + RMWg + FF.CMA, data=factor.mat)
Inv = (coef(fit)["(Intercept)"] / sd(fit$residuals))^2

RMWg = cbind(Sh2, Mkt, Size, Val, Prof, Inv, Mom)
rownames(RMWg) = c("Mkt, SMB, HML, RMWg, CMA, WML")
res = rbind(res, RMWg)
# round(res, 3)
```

## Rm, SMB, HMLm, RMWor, CMA, WML

```{r}
factor.mat = f %>% select(FF.Rm, FF.SMB, HMLm, RMWor, FF.CMA, WML)
factor.mat = factor.mat

R = matrix(colMeans(factor.mat), nrow=ncol(factor.mat), ncol=1)
covar.mat = cov(factor.mat)

# Max Sharpe Ratio
Sh2 = rbind(SR.sq.mat(R, covar.mat), sqrt(SR.sq.mat(R, covar.mat)[1]))[1]

# Marginal contributions from spanning regression

fit = lm(FF.Rm ~ FF.SMB + HMLm + RMWor + FF.CMA + WML, data=factor.mat)
# round(coef(fit), 3)
# round(sd(fit$residuals), 3)
Mkt = (coef(fit)["(Intercept)"] / sd(fit$residuals))^2

fit = lm(FF.SMB ~ FF.Rm + HMLm + RMWor + FF.CMA + WML, data=factor.mat)
# round(coef(fit), 3)
# round(sd(fit$residuals), 3)
Size = (coef(fit)["(Intercept)"] / sd(fit$residuals))^2

fit = lm(HMLm ~ FF.Rm + FF.SMB + RMWor + FF.CMA + WML, data=factor.mat)
# round(coef(fit), 3)
# round(sd(fit$residuals), 3)
Val = (coef(fit)["(Intercept)"] / sd(fit$residuals))^2

fit = lm(RMWor ~ FF.Rm + FF.SMB + HMLm + FF.CMA + WML, data=factor.mat)
# round(coef(fit), 3)
# round(sd(fit$residuals), 3)
Prof = (coef(fit)["(Intercept)"] / sd(fit$residuals))^2

fit = lm(FF.CMA ~ FF.Rm + FF.SMB + HMLm + RMWor + WML, data=factor.mat)
# round(coef(fit), 3)
# round(sd(fit$residuals), 3)
Inv = (coef(fit)["(Intercept)"] / sd(fit$residuals))^2

fit = lm(WML ~ FF.Rm + FF.SMB + HMLm + RMWor + FF.CMA, data=factor.mat)
# round(coef(fit), 3)
# round(sd(fit$residuals), 3)
Mom = (coef(fit)["(Intercept)"] / sd(fit$residuals))^2

RMWor = cbind(Sh2, Mkt, Size, Val, Prof, Inv, Mom)
rownames(RMWor) = c("Mkt, SMB, HMLm, RMWor, CMA, WML")
res = rbind(res, RMWor)
# round(res, 3)
```

## Rm, SMB, HMLm, RMWc, CMA, WML

```{r}
factor.mat = f %>% select(FF.Rm, FF.SMB, HMLm, RMWc, FF.CMA, WML)
factor.mat = factor.mat

R = matrix(colMeans(factor.mat), nrow=ncol(factor.mat), ncol=1)
covar.mat = cov(factor.mat)

# Max Sharpe Ratio
Sh2 = rbind(SR.sq.mat(R, covar.mat), sqrt(SR.sq.mat(R, covar.mat)[1]))[1]

# Marginal contributions from spanning regression

fit = lm(FF.Rm ~ FF.SMB + HMLm + RMWc + FF.CMA + WML, data=factor.mat)
Mkt = (coef(fit)["(Intercept)"] / sd(fit$residuals))^2

fit = lm(FF.SMB ~ FF.Rm + HMLm + RMWc + FF.CMA + WML, data=factor.mat)
Size = (coef(fit)["(Intercept)"] / sd(fit$residuals))^2

fit = lm(HMLm ~ FF.Rm + FF.SMB + RMWc + FF.CMA + WML, data=factor.mat)
Val = (coef(fit)["(Intercept)"] / sd(fit$residuals))^2

fit = lm(RMWc ~ FF.Rm + FF.SMB + HMLm + FF.CMA + WML, data=factor.mat)
Prof = (coef(fit)["(Intercept)"] / sd(fit$residuals))^2

fit = lm(FF.CMA ~ FF.Rm + FF.SMB + HMLm + RMWc + WML, data=factor.mat)
Inv = (coef(fit)["(Intercept)"] / sd(fit$residuals))^2

fit = lm(WML ~ FF.Rm + FF.SMB + HMLm + RMWc + FF.CMA, data=factor.mat)
Mom = (coef(fit)["(Intercept)"] / sd(fit$residuals))^2

RMWc = cbind(Sh2, Mkt, Size, Val, Prof, Inv, Mom)
rownames(RMWc) = c("Mkt, SMB, HMLm, RMWc, CMA, WML")
res = rbind(res, RMWc)
# round(res, 3)
```

## Rm, SMB, HMLm, RMWc, WML

```{r}
factor.mat = f %>% select(FF.Rm, FF.SMB, HMLm, RMWc, WML)
factor.mat = factor.mat

R = matrix(colMeans(factor.mat), nrow=ncol(factor.mat), ncol=1)
covar.mat = cov(factor.mat)

# Max Sharpe Ratio
Sh2 = rbind(SR.sq.mat(R, covar.mat), sqrt(SR.sq.mat(R, covar.mat)[1]))[1]

# Marginal contributions from spanning regression

fit = lm(FF.Rm ~ FF.SMB + HMLm + RMWc + WML, data=factor.mat)
Mkt = (coef(fit)["(Intercept)"] / sd(fit$residuals))^2

fit = lm(FF.SMB ~ FF.Rm + HMLm + RMWc + WML, data=factor.mat)
Size = (coef(fit)["(Intercept)"] / sd(fit$residuals))^2

fit = lm(HMLm ~ FF.Rm + FF.SMB + RMWc + WML, data=factor.mat)
Val = (coef(fit)["(Intercept)"] / sd(fit$residuals))^2

fit = lm(RMWc ~ FF.Rm + FF.SMB + HMLm + WML, data=factor.mat)
Prof = (coef(fit)["(Intercept)"] / sd(fit$residuals))^2

fit = lm(WML ~ FF.Rm + FF.SMB + HMLm + RMWc, data=factor.mat)
Mom = (coef(fit)["(Intercept)"] / sd(fit$residuals))^2

RMWc = cbind(Sh2, Mkt, Size, Val, Prof, NA, Mom)
rownames(RMWc) = c("Mkt, SMB, HMLm, RMWc, WML")
res = rbind(res, RMWc)
# round(res, 3)
```

## Rm, SMB, HMLm, RMWg, CMA, WML

```{r}
factor.mat = f %>% select(FF.Rm, FF.SMB, HMLm, RMWg, FF.CMA, WML)
factor.mat = factor.mat

R = matrix(colMeans(factor.mat), nrow=ncol(factor.mat), ncol=1)
covar.mat = cov(factor.mat)

# Max Sharpe Ratio
Sh2 = rbind(SR.sq.mat(R, covar.mat), sqrt(SR.sq.mat(R, covar.mat)[1]))[1]

# Marginal contributions from spanning regression

fit = lm(FF.Rm ~ FF.SMB + HMLm + RMWg + FF.CMA + WML, data=factor.mat)
Mkt = (coef(fit)["(Intercept)"] / sd(fit$residuals))^2

fit = lm(FF.SMB ~ FF.Rm + HMLm + RMWg + FF.CMA + WML, data=factor.mat)
Size = (coef(fit)["(Intercept)"] / sd(fit$residuals))^2

fit = lm(HMLm ~ FF.Rm + FF.SMB + RMWg + FF.CMA + WML, data=factor.mat)
Val = (coef(fit)["(Intercept)"] / sd(fit$residuals))^2

fit = lm(RMWg ~ FF.Rm + FF.SMB + HMLm + FF.CMA + WML, data=factor.mat)
Prof = (coef(fit)["(Intercept)"] / sd(fit$residuals))^2

fit = lm(FF.CMA ~ FF.Rm + FF.SMB + HMLm + RMWg + WML, data=factor.mat)
Inv = (coef(fit)["(Intercept)"] / sd(fit$residuals))^2

fit = lm(WML ~ FF.Rm + FF.SMB + HMLm + RMWg + FF.CMA, data=factor.mat)
Inv = (coef(fit)["(Intercept)"] / sd(fit$residuals))^2

RMWg = cbind(Sh2, Mkt, Size, Val, Prof, Inv, Mom)
rownames(RMWg) = c("Mkt, SMB, HMLm, RMWg, CMA, WML")
res = rbind(res, RMWg)
# round(res, 3) %>% as.data.frame
```

## Results

```{r}
kable(res, digits=3)
kable(res, digits=3, format="markdown")
```

# Anomalies

Downloaded from Dr. Kenneth French's
[website](http://mba.tuck.dartmouth.edu/pages/faculty/ken.french/data_library.html#Research)

Unconditional sorts (US)

* 25 Size BM
* 25 Size BMm
* 25 Size OP
* 25 Size GP
* 25 Size CP
* 25 Size INV
* 25 Size Mom
* 25 Size $\beta$
* 35 Size Net Share Issues (quintiles plus 0 and negative NI)
* 25 Size Variance
* 25 Size Residual Variance
* 25 Size Accruals
* (25 BM OP)
* (25 BM INV)
* (25 OP INV)

Conditional on Size sorts (US)

* 32 Size BM OP
* 32 Size BM INV
* 32 Size OP INV

```{r}
a = fread("C:/Data/FrenchDartmouth/25_Portfolios_5x5.CSV")[i:j,]

bmm = fread("C:/Data/Thesis/25_L1ME_BMM_Returns.CSV")[,-1]
bmm$Date = as.integer(substr(bmm$Date, 1, 4))*100 + as.integer(substr(bmm$Date, 6, 7))
a = left_join(a, bmm, by="Date")

a = left_join(a, fread("C:/Data/FrenchDartmouth/25_Portfolios_ME_OP_5x5.CSV"), by="Date")

gp = fread("C:/Data/Thesis/25_Size_GP_Returns.CSV")[,-1]
gp$Date = as.integer(substr(gp$Date, 1, 4))*100 + as.integer(substr(gp$Date, 6, 7))
a = left_join(a, gp, by="Date")

cp = fread("C:/Data/Thesis/25_Size_CP_Returns.CSV")[,-1]
cp$Date = as.integer(substr(cp$Date, 1, 4))*100 + as.integer(substr(cp$Date, 6, 7))
a = left_join(a, cp, by="Date")

a = left_join(a, fread("C:/Data/FrenchDartmouth/25_Portfolios_ME_INV_5x5.CSV"), by="Date")
a = left_join(a, fread("C:/Data/FrenchDartmouth/25_Portfolios_ME_Prior_12_2.CSV"), by="Date")
a = left_join(a, fread("C:/Data/FrenchDartmouth/25_Portfolios_ME_BETA_5x5.csv"), by="Date")
a = left_join(a, fread("C:/Data/FrenchDartmouth/25_Portfolios_ME_NI_5x5.csv"), by="Date")
a = left_join(a, fread("C:/Data/FrenchDartmouth/25_Portfolios_ME_VAR_5x5.csv"), by="Date")
a = left_join(a, fread("C:/Data/FrenchDartmouth/25_Portfolios_ME_RESVAR_5x5.csv"), by="Date")
a = left_join(a, fread("C:/Data/FrenchDartmouth/25_Portfolios_ME_AC_5x5.csv"), by="Date")
#a = left_join(a, fread("C:/Data/FrenchDartmouth/25_Portfolios_BEME_OP_5x5.csv"), by="Date")
#a = left_join(a, fread("C:/Data/FrenchDartmouth/25_Portfolios_BEME_INV_5x5.csv"), by="Date")
#a = left_join(a, fread("C:/Data/FrenchDartmouth/25_Portfolios_OP_INV_5x5.csv"), by="Date")

a = left_join(a, fread("C:/Data/FrenchDartmouth/32_Portfolios_ME_BEME_OP_2x4x4.CSV"), by="Date")
a = left_join(a, fread("C:/Data/FrenchDartmouth/32_Portfolios_ME_BEME_INV_2x4x4.CSV"), by="Date")
a = left_join(a, fread("C:/Data/FrenchDartmouth/32_Portfolios_ME_OP_INV_2x4x4.CSV"), by="Date")

dim(a)
summary(a$Date)
```

```{r}
a = a[,-1]
```

## FF.Rm+FF.SMB+HMLo+FF.RMW+FF.CMA

```{r}
cs = c()
ts = c()
reg.resid = c()

for (p in colnames(a)){  # not Date column
    model = paste0("`", p, "` -RF ~ FF.Rm+FF.SMB+HMLo+FF.RMW+FF.CMA")
    fit = lm(model, data=cbind(f, a))
    cs = rbind(cs, coef(fit))
    ts = rbind(ts, coef(summary(fit))[,3])
    reg.resid = cbind(reg.resid, fit$residuals)
}
colnames(cs) = c("a", "Rm", "s", "h", "r", "c")
colnames(ts) = c("a", "Rm", "s", "h", "r", "c")
colnames(ts) = paste0("t(", colnames(ts), ")")

regs = as.data.frame(cbind(cs, ts))
rownames(regs) = colnames(a)
write.csv(regs, "C:/Data/Thesis/FF-Rm_FF-SMB_HMLo_FF-RMW_FF-CMA_Anomalies.csv")
round(summary(abs(regs$a)), 2)
sum(abs(regs["t(a)"])>2)

# Sharpe squared intercepts
SR.sq.mat(regs$a, cov(reg.resid))
# Average absolute intercepts
(mean(abs(regs$a)))
```

## FF.Rm+FF.SMB+FF.HML+RMWor+FF.CMA

```{r}
cs = c()
ts = c()
reg.resid = c()

for (p in colnames(a)){
    model = paste0("`", p, "` -RF~ FF.Rm+FF.SMB+FF.HML+RMWor+FF.CMA")
    fit = lm(model, data=cbind(f, a))
    cs = rbind(cs, coef(fit))
    ts = rbind(ts, coef(summary(fit))[,3])
    reg.resid = cbind(reg.resid, fit$residuals)
}
colnames(cs) = c("a", "Rm", "s", "h", "r", "c")
colnames(ts) = c("a", "Rm", "s", "h", "r", "c")
colnames(ts) = paste0("t(", colnames(ts), ")")

regs = as.data.frame(cbind(cs, ts))
rownames(regs) = colnames(a)
write.csv(regs, "C:/Data/Thesis/FF-Rm_FF-SMB_FF-HML_RMWor_FF-CMA_Anomalies.csv")
round(summary(abs(regs$a)), 2)
sum(abs(regs["t(a)"])>2)

# Sharpe squared intercepts
SR.sq.mat(regs$a, cov(reg.resid))
# Average absolute intercepts
(mean(abs(regs$a)))
```

## FF.Rm+FF.SMB+FF.HML+RMWc+FF.CMA

```{r}
cs = c()
ts = c()
reg.resid = c()

for (p in colnames(a)){
    model = paste0("`", p, "` -RF~ FF.Rm+FF.SMB+FF.HML+RMWc+FF.CMA")
    fit = lm(model, data=cbind(f, a))
    cs = rbind(cs, coef(fit))
    ts = rbind(ts, coef(summary(fit))[,3])
    reg.resid = cbind(reg.resid, fit$residuals)
}
colnames(cs) = c("a", "Rm", "s", "h", "r", "c")
colnames(ts) = c("a", "Rm", "s", "h", "r", "c")
colnames(ts) = paste0("t(", colnames(ts), ")")

regs = as.data.frame(cbind(cs, ts))
rownames(regs) = colnames(a)
write.csv(regs, "C:/Data/Thesis/FF-Rm_FF-SMB_FF-HML_RMWc_FF-CMA_Anomalies.csv")
round(summary(abs(regs$a)), 2)
sum(abs(regs["t(a)"])>2)

# Sharpe squared intercepts
SR.sq.mat(regs$a, cov(reg.resid))
# Average absolute intercepts
(mean(abs(regs$a)))
```

## FF.Rm+FF.SMB+HMLm+RMWg+FF.CMA+WML

```{r}
cs = c()
ts = c()
reg.resid = c()

for (p in colnames(a)){
    model = paste0("`", p, "` -RF~ FF.Rm+FF.SMB+HMLm+RMWg+FF.CMA+WML")
    fit = lm(model, data=cbind(f, a))
    cs = rbind(cs, coef(fit))
    ts = rbind(ts, coef(summary(fit))[,3])
    reg.resid = cbind(reg.resid, fit$residuals)
}
colnames(cs) = c("a", "Rm", "s", "h", "r", "c", "w")
colnames(ts) = c("a", "Rm", "s", "h", "r", "c", "w")
colnames(ts) = paste0("t(", colnames(ts), ")")

regs = as.data.frame(cbind(cs, ts))
rownames(regs) = colnames(a)
write.csv(regs, "C:/Data/Thesis/FF-Rm_FF-SMB_HMLm_RMWg_FF-CMA_WML_Anomalies.csv")
round(summary(abs(regs$a)), 2)
sum(abs(regs["t(a)"])>2)

# Sharpe squared intercepts
SR.sq.mat(regs$a, cov(reg.resid))
# Average absolute intercepts
(mean(abs(regs$a)))
```

## FF.Rm+FF.SMB+HMLm+RMWc+FF.CMA+WML

```{r}
cs = c()
ts = c()

for (p in colnames(a)){
    model = paste0("`", p, "` -RF~ FF.Rm+FF.SMB+HMLm+RMWc+FF.CMA+WML")
    fit = lm(model, data=cbind(f, a))
    cs = rbind(cs, coef(fit))
    ts = rbind(ts, coef(summary(fit))[,3])
}
colnames(cs) = c("a", "Rm", "s", "h", "r", "c", "w")
colnames(ts) = c("a", "Rm", "s", "h", "r", "c", "w")
colnames(ts) = paste0("t(", colnames(ts), ")")

regs = as.data.frame(cbind(cs, ts))
rownames(regs) = colnames(a)
write.csv(regs, "C:/Data/Thesis/FF-Rm_FF-SMB_HMLm_RMWc_FF-CMA_WML_Anomalies.csv")
round(summary(abs(regs$a)), 2)
sum(abs(regs["t(a)"])>2)

# Sharpe squared intercepts
SR.sq.mat(regs$a, cov(reg.resid))
# Average absolute intercepts
(mean(abs(regs$a)))
```

## FF.Rm+FF.SMB+HMLm+RMWc+WML

```{r}
cs = c()
ts = c()
reg.resid = c()

for (p in colnames(a)){
    model = paste0("`", p, "` -RF~ FF.Rm+FF.SMB+HMLm+RMWc+WML")
    fit = lm(model, data=cbind(f, a))
    cs = rbind(cs, coef(fit))
    ts = rbind(ts, coef(summary(fit))[,3])
    reg.resid = cbind(reg.resid, fit$residuals)
}
colnames(cs) = c("a", "Rm", "s", "h", "r", "w")
colnames(ts) = c("a", "Rm", "s", "h", "r", "w")
colnames(ts) = paste0("t(", colnames(ts), ")")

regs = as.data.frame(cbind(cs, ts))
rownames(regs) = colnames(a)
write.csv(regs, "C:/Data/Thesis/FF-Rm_FF-SMB_HMLm_RMWc_WML_Anomalies.csv")
round(summary(abs(regs$a)), 2)
sum(abs(regs["t(a)"])>2)

# Sharpe squared intercepts
SR.sq.mat(regs$a, cov(reg.resid))
# Average absolute intercepts
(mean(abs(regs$a)))
```

